<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>NUR & ILM | Digital Tadabbur Pro v2</title>
    
    <!-- LIBRARIES (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- CORE STYLING --- */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@200;400;600&display=swap');

        body {
            margin: 0;
            background-color: #000000;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: #e5e7eb;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
        }

        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, transparent 0%, #000000 130%);
            transition: opacity 1s ease;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            opacity: 0.8;
            pointer-events: auto; 
        }

        .zikr-container {
            text-align: left;
        }
        
        .zikr-count {
            font-size: 24px;
            font-weight: 200;
            color: #34d399;
            letter-spacing: 2px;
            font-variant-numeric: tabular-nums;
        }

        .zikr-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #059669;
            display: block;
        }

        .reset-btn {
            background: transparent;
            border: 1px solid #064e3b;
            color: #064e3b;
            font-size: 8px;
            padding: 2px 8px;
            margin-top: 5px;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .reset-btn:hover {
            border-color: #10b981;
            color: #10b981;
        }

        .status-badge {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 5px 10px;
            border: 1px solid #10b981;
            color: #10b981;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.1);
            text-align: right;
        }
        .status-badge.error { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        /* Center Content (Ayah) */
        .content-wrapper {
            text-align: center;
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .content-wrapper.fade-out {
            opacity: 0;
            transform: translate(-50%, -45%);
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            color: #fffbeb;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
            line-height: 1.8;
            font-weight: 400;
        }

        .divider {
            width: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            margin: 20px auto;
            opacity: 0.5;
        }

        .uzbek-text {
            font-size: clamp(0.9rem, 2.5vw, 1.3rem);
            font-weight: 300;
            font-style: italic;
            color: #ecfdf5;
            letter-spacing: 0.5px;
            line-height: 1.5;
        }

        .meta-text {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #059669;
            margin-top: 15px;
        }

        /* Footer (Hikmah & Credits) */
        .footer {
            margin-bottom: 10px;
            text-align: center;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .hikmah-box {
            background: rgba(0, 10, 5, 0.4);
            border-left: 2px solid #059669;
            padding: 10px 20px;
            backdrop-filter: blur(8px);
            max-width: 650px;
            margin: 0 auto;
            border-radius: 0 8px 8px 0;
        }
        
        .hikmah-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #34d399;
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .hikmah-content {
            font-size: 11px;
            color: #9ca3af;
            line-height: 1.5;
        }

        .credits {
            font-size: 9px;
            color: #333;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Navigation Buttons */
        .nav-buttons {
            pointer-events: auto;
            display: flex;
            gap: 40px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.1);
            color: #555;
            font-size: 14px;
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-btn:hover {
            border-color: #10b981;
            color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        /* Start Screen */
        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000000;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .start-btn {
            margin-top: 40px;
            padding: 15px 50px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #e5e5e5;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-size: 11px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .start-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.15);
            letter-spacing: 6px;
        }

        .hidden { opacity: 0; pointer-events: none; transition: opacity 1.5s ease; }
        .visible { opacity: 1; pointer-events: auto; }

        /* Zikr Pulse Effect */
        @keyframes zikrPulse {
            0% { transform: scale(1); text-shadow: 0 0 0 rgba(52, 211, 153, 0); }
            50% { transform: scale(1.2); text-shadow: 0 0 20px rgba(52, 211, 153, 0.8); }
            100% { transform: scale(1); text-shadow: 0 0 0 rgba(52, 211, 153, 0); }
        }
        .pulse-text { animation: zikrPulse 0.4s ease-out; color: #fff !important; }

    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="start-screen">
        <h1 style="font-weight: 200; letter-spacing: 8px; font-size: 32px; margin-bottom: 10px; color: #fff;">NUR & ILM</h1>
        <p style="font-size: 10px; color: #666; letter-spacing: 3px; text-transform: uppercase;">PRO VERSION</p>
        <button class="start-btn" id="btn-start">Bismillah â€¢ Kirish</button>
        <p style="margin-top: 30px; font-size: 9px; color: #333;">Kamera va Ovoz talab qilinadi.<br>Sokin joyda, "ğŸ‘Œ" ishorasi bilan Zikr qiling.</p>
        <div style="position: absolute; bottom: 20px; font-size: 8px; color: #222;">Made by Â©ï¸Muhammad Daler</div>
    </div>

    <!-- MAIN UI -->
    <div id="ui-layer" class="hidden">
        <div class="header">
            <div class="zikr-container">
                <span class="zikr-label">ZIKR</span>
                <div id="zikr-display" class="zikr-count">0</div>
                <button onclick="app.resetZikr()" class="reset-btn">Reset</button>
            </div>
            
            <div style="text-align: right;">
                <div id="hand-status" class="status-badge error">Kamera...</div>
                <div id="pinch-status" style="font-size: 9px; margin-top: 5px; letter-spacing: 1px; color: #444; transition: color 0.3s;">ğŸ‘Œ BOSIB TURING</div>
            </div>
        </div>

        <div class="content-wrapper" id="content-box">
            <div id="arabic" class="arabic-text"></div>
            <div class="divider"></div>
            <div id="uzbek" class="uzbek-text"></div>
            <div id="meta" class="meta-text"></div>
        </div>

        <div class="footer">
            <div class="hikmah-box">
                <span id="hikmah-source" class="hikmah-title"></span>
                <span id="hikmah-body" class="hikmah-content"></span>
            </div>
            
            <div class="nav-buttons">
                <button onclick="app.prevAyah()" class="nav-btn">â†</button>
                <button onclick="app.nextAyah()" class="nav-btn">â†’</button>
            </div>
            
            <div class="credits">Made by Â©ï¸Muhammad Daler</div>
        </div>
    </div>

    <!-- 3D CANVAS -->
    <div id="canvas-container"></div>
    <!-- HIDDEN VIDEO -->
    <video id="input_video" style="display:none" playsinline webkit-playsinline></video>

    <script>
        /**
         * NUR & ILM PRO - Kengaytirilgan Versiya
         * Muallif: Muhammad Daler
         * Funksiyalar: 3D Fizika, Zikr Counter, Generativ Ovoz, MediaPipe Hand Tracking
         */

        // --- 1. KENGAYTIRILGAN MA'LUMOTLAR BAZASI (35+ OYATLAR) ---
        const AYAHS = [
            // 1-5 (Originals Enhanced)
            {
                id: 1, surah: "An-Nur 24:35",
                arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù†ÙÙˆØ±Ù Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙØ§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù",
                uzbek: "Alloh osmonlar va yerning nuridir.",
                source: "Fizika (Optika/Energiya)",
                hikmah: "Koinotdagi barcha materiya aslida quyuqlashgan nur (energiya)dir (E=mcÂ²). Zulmat mustaqil mavjud emas, u faqat nurning yo'qligidir.",
                shape: 'SPHERE'
            },
            {
                id: 2, surah: "Al-Anbiya 21:30",
                arabic: "Ø£ÙÙˆÙÙ„ÙÙ…Ù’ ÙŠÙØ±Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù ÙƒÙÙÙØ±ÙÙˆØ§ Ø£ÙÙ†ÙÙ‘ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙØ§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù ÙƒÙØ§Ù†ÙØªÙØ§ Ø±ÙØªÙ’Ù‚Ù‹Ø§ ÙÙÙÙØªÙÙ‚Ù’Ù†ÙØ§Ù‡ÙÙ…ÙØ§",
                uzbek: "Osmonlar va Yer bitishgan edilar, Biz ularni ajratdik.",
                source: "Kosmologiya (Katta Portlash)",
                hikmah: "Zamonaviy fan Koinot 'Singulyar' nuqtadan kengayib paydo bo'lganini tasdiqlaydi. Biz hammamiz bir paytlar bitta nuqtada edik.",
                shape: 'EXPANSION'
            },
            {
                id: 3, surah: "Az-Zariyat 51:47",
                arabic: "ÙˆÙØ§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù Ø¨ÙÙ†ÙÙŠÙ’Ù†ÙØ§Ù‡ÙØ§ Ø¨ÙØ£ÙÙŠÙ’Ø¯Ù ÙˆÙØ¥ÙÙ†ÙÙ‘Ø§ Ù„ÙÙ…ÙÙˆØ³ÙØ¹ÙÙˆÙ†Ù",
                uzbek: "Osmonni kuch-qudrat bilan bino qildik va albatta, Biz uni kengaytiruvchimiz.",
                source: "Astrofizika (Kengayuvchi Koinot)",
                hikmah: "Koinot statik emas, u doimiy ravishda kengaymoqda. Hubble qonuni buni 20-asrda kashf qildi, Qur'on esa 14 asr oldin aytdi.",
                shape: 'GALAXY'
            },
            {
                id: 4, surah: "Al-Hadid 57:25",
                arabic: "ÙˆÙØ£ÙÙ†Ø²ÙÙ„Ù’Ù†ÙØ§ Ø§Ù„Ù’Ø­ÙØ¯ÙÙŠØ¯Ù ÙÙÙŠÙ‡Ù Ø¨ÙØ£Ù’Ø³ÙŒ Ø´ÙØ¯ÙÙŠØ¯ÙŒ ÙˆÙÙ…ÙÙ†ÙØ§ÙÙØ¹Ù Ù„ÙÙ„Ù†ÙÙ‘Ø§Ø³Ù",
                uzbek: "Va Biz temirni tushirdik. Unda kuchli, shiddatli zarba va odamlar uchun manfaatlar bor.",
                source: "Astrofizika (Temirning Paydo Bo'lishi)",
                hikmah: "Temir Yerda hosil bo'lmaydi. U o'ta yangi yulduzlar (Supernova) portlashi natijasida koinotdan 'tushirilgan' elementdir.",
                shape: 'CUBE' // Crystal structure
            },
            {
                id: 5, surah: "Az-Zumar 39:6",
                arabic: "Ø®ÙÙ„ÙÙ‚ÙÙƒÙÙ… Ù…ÙÙ‘Ù† Ù†ÙÙ‘ÙÙ’Ø³Ù ÙˆÙØ§Ø­ÙØ¯ÙØ©Ù Ø«ÙÙ…ÙÙ‘ Ø¬ÙØ¹ÙÙ„Ù Ù…ÙÙ†Ù’Ù‡ÙØ§ Ø²ÙÙˆÙ’Ø¬ÙÙ‡ÙØ§",
                uzbek: "U sizlarni bir jondan yaratdi, so'ngra undan juftini qildi.",
                source: "Biologiya (Genetika)",
                hikmah: "Barcha insoniyat yagona genetik koddan (DNK) kelib chiqqan. Hujayra bo'linishi hayotning davomiyligini ta'minlaydi.",
                shape: 'DNA'
            },
            // Yangi Oyatlar 6-35
            {
                id: 6, surah: "Ya-Sin 36:38",
                arabic: "ÙˆÙØ§Ù„Ø´ÙÙ‘Ù…Ù’Ø³Ù ØªÙØ¬Ù’Ø±ÙÙŠ Ù„ÙÙ…ÙØ³Ù’ØªÙÙ‚ÙØ±ÙÙ‘ Ù„ÙÙ‘Ù‡ÙØ§",
                uzbek: "Quyosh ham o'z istiqrori (belgilangan yo'li) sari joriy bo'lur.",
                source: "Astronomiya (Quyosh Orbitasi)",
                hikmah: "Quyosh joyida turmaydi, u Somon Yo'li galaktikasi markazi atrofida soatiga 800,000 km tezlikda harakatlanadi.",
                shape: 'VORTEX'
            },
            {
                id: 7, surah: "At-Tariq 86:11",
                arabic: "ÙˆÙØ§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù Ø°ÙØ§ØªÙ Ø§Ù„Ø±ÙÙ‘Ø¬Ù’Ø¹Ù",
                uzbek: "Qaytaruvchi osmon bilan qasam.",
                source: "Atmosfera Fizikasi",
                hikmah: "Osmon (atmosfera) suv bug'ini yomg'ir qilib qaytaradi, radioto'lqinlarni qaytaradi va zararli nurlarni koinotga qaytaradi.",
                shape: 'WAVE'
            },
            {
                id: 8, surah: "An-Naba 78:7",
                arabic: "ÙˆÙØ§Ù„Ù’Ø¬ÙØ¨ÙØ§Ù„Ù Ø£ÙÙˆÙ’ØªÙØ§Ø¯Ù‹Ø§",
                uzbek: "Va tog'larni qoziqlar qilib qo'ymadikmi?",
                source: "Geologiya (Izostaziya)",
                hikmah: "Tog'larning yer ostida chuqur ildizlari bor (qoziq kabi). Bu Yer qobig'ining (litosfera) muvozanatini saqlaydi.",
                shape: 'PYRAMID'
            },
            {
                id: 9, surah: "Al-Mulk 67:3",
                arabic: "Ù…ÙÙ‘Ø§ ØªÙØ±ÙÙ‰Ù° ÙÙÙŠ Ø®ÙÙ„Ù’Ù‚Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù…ÙÙ† ØªÙÙÙØ§ÙˆÙØªÙ",
                uzbek: "Rahmonning yaratganida biror tafovut (nuqson) ko'rmaysan.",
                source: "Fizika (Nozik Sozlanish)",
                hikmah: "Koinotdagi barcha fizik konstantalar (gravitatsiya, elektromagnetizm) shunday aniq sozlanganki, ozgina o'zgarish hayotni yo'q qilardi.",
                shape: 'NETWORK' // Web/Connections
            },
            {
                id: 10, surah: "Az-Zariyat 51:49",
                arabic: "ÙˆÙÙ…ÙÙ† ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù Ø®ÙÙ„ÙÙ‚Ù’Ù†ÙØ§ Ø²ÙÙˆÙ’Ø¬ÙÙŠÙ’Ù†Ù Ù„ÙØ¹ÙÙ„ÙÙ‘ÙƒÙÙ…Ù’ ØªÙØ°ÙÙƒÙÙ‘Ø±ÙÙˆÙ†Ù",
                uzbek: "Eslatma olishingiz uchun biz har bir narsani juft qilib yaratdik.",
                source: "Kvant Fizikasi (Juftlik)",
                hikmah: "Materiya va Antimateriya, Elektron va Proton, Shimol va Janub qutblari. Koinot muvozanat va qarama-qarshiliklar ustiga qurilgan.",
                shape: 'DUALITY' // Two spheres orbiting
            },
            {
                id: 11, surah: "Al-Ankabut 29:41",
                arabic: "Ù…ÙØ«ÙÙ„Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø§ØªÙÙ‘Ø®ÙØ°ÙÙˆØ§ Ù…ÙÙ† Ø¯ÙÙˆÙ†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙˆÙ’Ù„ÙÙŠÙØ§Ø¡Ù ÙƒÙÙ…ÙØ«ÙÙ„Ù Ø§Ù„Ù’Ø¹ÙÙ†ÙƒÙØ¨ÙÙˆØªÙ Ø§ØªÙÙ‘Ø®ÙØ°ÙØªÙ’ Ø¨ÙÙŠÙ’ØªÙ‹Ø§",
                uzbek: "Allohdan o'zga do'stlar tutganlarning misoli xuddi uy qurib olgan o'rgimchakka o'xshaydi.",
                source: "Muhandislik (O'rgimchak Ipi)",
                hikmah: "O'rgimchak ipi po'latdan mustahkam, lekin uning uyi (oilasi) zaif. Tabiatdagi geometriya va mustahkamlik mo'jizasi.",
                shape: 'WEB'
            },
            {
                id: 12, surah: "Fussilat 41:11",
                arabic: "Ø«ÙÙ…ÙÙ‘ Ø§Ø³Ù’ØªÙÙˆÙÙ‰Ù° Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù ÙˆÙÙ‡ÙÙŠÙ Ø¯ÙØ®ÙØ§Ù†ÙŒ",
                uzbek: "So'ngra tutun holidagi osmonni iroda qildi.",
                source: "Kosmologiya (Gaz Bulutlari)",
                hikmah: "Yulduzlar va galaktikalar paydo bo'lishidan oldin koinot qizigan gaz va chang (tutun) bulutlaridan iborat edi.",
                shape: 'SMOKE'
            },
            {
                id: 13, surah: "Al-An'am 6:95",
                arabic: "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙÙØ§Ù„ÙÙ‚Ù Ø§Ù„Ù’Ø­ÙØ¨ÙÙ‘ ÙˆÙØ§Ù„Ù†ÙÙ‘ÙˆÙÙ‰Ù°",
                uzbek: "Albatta, Alloh donni va danakni yoruvchidir.",
                source: "Biologiya (O'sish)",
                hikmah: "Kichik bir urug' ichida ulkan daraxtning butun dasturi (genetik kodi) yashiringan. Hayotning uyg'onishi - ilohiy qudrat.",
                shape: 'SPIRAL'
            },
            {
                id: 14, surah: "Al-Qamar 54:49",
                arabic: "Ø¥ÙÙ†ÙÙ‘Ø§ ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù Ø®ÙÙ„ÙÙ‚Ù’Ù†ÙØ§Ù‡Ù Ø¨ÙÙ‚ÙØ¯ÙØ±Ù",
                uzbek: "Albatta, Biz har bir narsani o'lchov bilan yaratdik.",
                source: "Matematika (Oltin Kesim)",
                hikmah: "Tabiatdagi barglardan tortib galaktikalargacha hamma narsa aniq matematik qonuniyatlar (Fibonachchi ketma-ketligi) asosida qurilgan.",
                shape: 'TORUS'
            },
            {
                id: 15, surah: "Ar-Rahman 55:19-20",
                arabic: "Ù…ÙØ±ÙØ¬Ù Ø§Ù„Ù’Ø¨ÙØ­Ù’Ø±ÙÙŠÙ’Ù†Ù ÙŠÙÙ„Ù’ØªÙÙ‚ÙÙŠÙØ§Ù†Ù Ø¨ÙÙŠÙ’Ù†ÙÙ‡ÙÙ…ÙØ§ Ø¨ÙØ±Ù’Ø²ÙØ®ÙŒ Ù„ÙÙ‘Ø§ ÙŠÙØ¨Ù’ØºÙÙŠÙØ§Ù†Ù",
                uzbek: "U ikki dengizni bir-biri bilan uchrashadigan qilib qo'yverdi. O'rtalarida to'siq bor, aralashib ketmaslar.",
                source: "Okeanologiya (Suv Zichligi)",
                hikmah: "Dengiz suvlarining zichligi va sho'rligi har xil bo'lgani uchun ular ko'rinmas fizika qonunlari bilan chegaralanadi.",
                shape: 'WAVE_SPLIT'
            },
            {
                id: 16, surah: "An-Nahl 16:68",
                arabic: "ÙˆÙØ£ÙÙˆÙ’Ø­ÙÙ‰Ù° Ø±ÙØ¨ÙÙ‘ÙƒÙ Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù†ÙÙ‘Ø­Ù’Ù„Ù",
                uzbek: "Robbing asalariga vahiy (ilhom) qildi.",
                source: "Entomologiya (Asalarilar)",
                hikmah: "Asalarilarning olti burchakli uylari eng kam mum sarflab, eng ko'p asal saqlash imkonini beruvchi mukammal muhandislik yechimidir.",
                shape: 'HEXAGON'
            },
            {
                id: 17, surah: "Al-Insan 76:2",
                arabic: "Ø¥ÙÙ†ÙÙ‘Ø§ Ø®ÙÙ„ÙÙ‚Ù’Ù†ÙØ§ Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ù…ÙÙ† Ù†ÙÙ‘Ø·Ù’ÙÙØ©Ù Ø£ÙÙ…Ù’Ø´ÙØ§Ø¬Ù",
                uzbek: "Biz insonni aralash nutfadan yaratdik.",
                source: "Embriologiya",
                hikmah: "Inson otaning va onaning xromosomalari aralashuvidan (zigota) paydo bo'ladi. Bu mikroskopik olamdagi buyuk boshlanish.",
                shape: 'CELL_DIVIDE'
            },
            {
                id: 18, surah: "Qaf 50:6",
                arabic: "Ø£ÙÙÙÙ„ÙÙ…Ù’ ÙŠÙÙ†Ø¸ÙØ±ÙÙˆØ§ Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù ÙÙÙˆÙ’Ù‚ÙÙ‡ÙÙ…Ù’ ÙƒÙÙŠÙ’ÙÙ Ø¨ÙÙ†ÙÙŠÙ’Ù†ÙØ§Ù‡ÙØ§ ÙˆÙØ²ÙÙŠÙÙ‘Ù†ÙÙ‘Ø§Ù‡ÙØ§",
                uzbek: "Tepalaridagi osmonga nazar solmaydilarmi? Biz uni qandoq bino qildik va ziynatladik.",
                source: "Astranomiya (Kuzatuv)",
                hikmah: "Yulduzlar osmonning ziynatidir. Ularning joylashuvi va nuri koinotning ulug'vorligini va bizning naqadar kichikligimizni eslatadi.",
                shape: 'CONSTELLATION'
            },
            {
                id: 19, surah: "Yunus 10:5",
                arabic: "Ù‡ÙÙˆÙ Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ø¬ÙØ¹ÙÙ„Ù Ø§Ù„Ø´ÙÙ‘Ù…Ù’Ø³Ù Ø¶ÙÙŠÙØ§Ø¡Ù‹ ÙˆÙØ§Ù„Ù’Ù‚ÙÙ…ÙØ±Ù Ù†ÙÙˆØ±Ù‹Ø§",
                uzbek: "U quyoshni ziyo (yondiruvchi nur), oyni esa nur (aks etuvchi) qilgan zotdir.",
                source: "Fizika (Nur Manbalari)",
                hikmah: "Quyosh termoyadroviy reaksiya tufayli o'zidan nur va issiqlik chiqaradi (Ziyo). Oy esa Quyosh nurini qaytaradi xolos (Nur).",
                shape: 'SUN_MOON'
            },
            {
                id: 20, surah: "Al-Baqara 2:164",
                arabic: "ÙˆÙØªÙØµÙ’Ø±ÙÙŠÙÙ Ø§Ù„Ø±ÙÙ‘ÙŠÙØ§Ø­Ù ÙˆÙØ§Ù„Ø³ÙÙ‘Ø­ÙØ§Ø¨Ù Ø§Ù„Ù’Ù…ÙØ³ÙØ®ÙÙ‘Ø±Ù",
                uzbek: "Shamollarning yo'naltirilishida va bo'ysundirilgan bulutlarda aql yuritadigan qavm uchun belgilar bor.",
                source: "Meteorologiya",
                hikmah: "Shamollar shunchaki havo harakati emas, ular yomg'ir bulutlarini haydaydi, o'simliklarni changlatadi va haroratni muvozanatlashtiradi.",
                shape: 'WIND_FLOW'
            },
            {
                id: 21, surah: "Ar-Rum 30:22",
                arabic: "ÙˆÙÙ…ÙÙ†Ù’ Ø¢ÙŠÙØ§ØªÙÙ‡Ù Ø®ÙÙ„Ù’Ù‚Ù Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙØ§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù ÙˆÙØ§Ø®Ù’ØªÙÙ„ÙØ§ÙÙ Ø£ÙÙ„Ù’Ø³ÙÙ†ÙØªÙÙƒÙÙ…Ù’ ÙˆÙØ£ÙÙ„Ù’ÙˆÙØ§Ù†ÙÙƒÙÙ…Ù’",
                uzbek: "Osmonlaru yerning yaratilishi hamda tillaringiz va ranglaringizning turlicha bo'lishi Uning belgilaridandir.",
                source: "Antropologiya/Lingvistika",
                hikmah: "Turli millat va tillar insoniyatning boyligidir. Bu xilma-xillik tanishish va hamkorlik qilish uchun berilgan ne'matdir.",
                shape: 'EARTH_GLOBE'
            },
            {
                id: 22, surah: "An-Nur 24:43",
                arabic: "Ø£ÙÙ„ÙÙ…Ù’ ØªÙØ±Ù Ø£ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ²Ù’Ø¬ÙÙŠ Ø³ÙØ­ÙØ§Ø¨Ù‹Ø§ Ø«ÙÙ…ÙÙ‘ ÙŠÙØ¤ÙÙ„ÙÙ‘ÙÙ Ø¨ÙÙŠÙ’Ù†ÙÙ‡Ù",
                uzbek: "Allohning bulutlarni haydashini, so'ngra ularni birlashtirishini ko'rmadingmi?",
                source: "Fizika (Gidrologiya)",
                hikmah: "Yomg'ir hosil bo'lishi uchun bulutlar ma'lum bir tartibda birlashishi (kondensatsiya) va elektr zaryadlari to'planishi kerak.",
                shape: 'CLOUD_RAIN'
            },
            {
                id: 23, surah: "Al-Mursalat 77:25-26",
                arabic: "Ø£ÙÙ„ÙÙ…Ù’ Ù†ÙØ¬Ù’Ø¹ÙÙ„Ù Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù ÙƒÙÙÙØ§ØªÙ‹Ø§ * Ø£ÙØ­Ù’ÙŠÙØ§Ø¡Ù‹ ÙˆÙØ£ÙÙ…Ù’ÙˆÙØ§ØªÙ‹Ø§",
                uzbek: "Biz yerni tiriklar va o'liklarni o'z ichiga oluvchi qilmadikmi?",
                source: "Ekologiya (Recycling)",
                hikmah: "Yer - mukammal qayta ishlash tizimi. O'lik materiya parchalanib, yangi hayot uchun oziqaga aylanadi. Tabiatda chiqindi yo'q.",
                shape: 'CYCLE'
            },
            {
                id: 24, surah: "Al-Hajj 22:65",
                arabic: "ÙˆÙÙŠÙÙ…Ù’Ø³ÙÙƒÙ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù Ø£ÙÙ† ØªÙÙ‚ÙØ¹Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ¥ÙØ°Ù’Ù†ÙÙ‡Ù",
                uzbek: "U osmonni yerga qulab tushishidan O'z izni ila ushlab turadi.",
                source: "Fizika (Gravitatsiya va Markazdan qochma kuch)",
                hikmah: "Sayyoralar va yulduzlar nozik muvozanat (Gravitatsiya) tufayli o'z orbitalarida turadi. Agar bu kuch yo'qolsa, koinot qulardi.",
                shape: 'ORBIT_HOLD'
            },
            {
                id: 25, surah: "At-Takwir 81:15-16",
                arabic: "ÙÙÙ„ÙØ§ Ø£ÙÙ‚Ù’Ø³ÙÙ…Ù Ø¨ÙØ§Ù„Ù’Ø®ÙÙ†ÙÙ‘Ø³Ù * Ø§Ù„Ù’Ø¬ÙÙˆÙØ§Ø±Ù Ø§Ù„Ù’ÙƒÙÙ†ÙÙ‘Ø³Ù",
                uzbek: "Berkinib turuvchi, harakatlanib uyasiga kirib ketuvchi yulduzlar bilan qasam.",
                source: "Astrofizika (Qora Tuynuklar)",
                hikmah: "Ba'zi olimlar bu oyatni yorug'likni ham yutib yuboradigan, ko'rinmas lekin ulkan massaga ega Qora Tuynuklarga ishora deb biladilar.",
                shape: 'BLACK_HOLE'
            },
            {
                id: 26, surah: "Al-Waqi'a 56:75",
                arabic: "ÙÙÙ„ÙØ§ Ø£ÙÙ‚Ù’Ø³ÙÙ…Ù Ø¨ÙÙ…ÙÙˆÙØ§Ù‚ÙØ¹Ù Ø§Ù„Ù†ÙÙ‘Ø¬ÙÙˆÙ…Ù",
                uzbek: "Yulduzlarning joylari (mavqelari) bilan qasam ichaman.",
                source: "Astronomiya (Yorug'lik tezligi)",
                hikmah: "Biz ko'rayotgan yulduzning o'zi emas, uning o'tmishdagi 'joyi'dir. Yorug'lik yillab yo'l bosguncha yulduz u yerdan ketib bo'lgan bo'ladi.",
                shape: 'STAR_FIELD'
            },
             {
                id: 27, surah: "Az-Zumar 39:5",
                arabic: "ÙŠÙÙƒÙÙˆÙÙ‘Ø±Ù Ø§Ù„Ù„ÙÙ‘ÙŠÙ’Ù„Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù†ÙÙ‘Ù‡ÙØ§Ø±Ù ÙˆÙÙŠÙÙƒÙÙˆÙÙ‘Ø±Ù Ø§Ù„Ù†ÙÙ‘Ù‡ÙØ§Ø±Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù„ÙÙ‘ÙŠÙ’Ù„Ù",
                uzbek: "Tunni kun ustiga o'raydi, kunni tun ustiga o'raydi.",
                source: "Geografiya (Yerning shakli)",
                hikmah: "'Yukavviru' so'zi sallani boshga o'rash kabi narsani yumaloq jismga o'rashni anglatadi. Bu Yerning sharsimon ekanligiga nozik ishoradir.",
                shape: 'SPHERE_ROTATE'
            },
             {
                id: 28, surah: "Ar-Rahman 55:33",
                arabic: "ÙŠÙØ§ Ù…ÙØ¹Ù’Ø´ÙØ±Ù Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘ ÙˆÙØ§Ù„Ù’Ø¥ÙÙ†Ø³Ù Ø¥ÙÙ†Ù Ø§Ø³Ù’ØªÙØ·ÙØ¹Ù’ØªÙÙ…Ù’ Ø£ÙÙ† ØªÙÙ†ÙÙØ°ÙÙˆØ§ Ù…ÙÙ†Ù’ Ø£ÙÙ‚Ù’Ø·ÙØ§Ø±Ù Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙØ§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù ÙÙØ§Ù†ÙÙØ°ÙÙˆØ§",
                uzbek: "Ey jin va ins jamoasi! Agar osmonlaru yer chegaralaridan o'tib ketishga qodir bo'lsangiz, o'tib ketingiz!",
                source: "Kosmonavtika",
                hikmah: "Yerni tark etish uchun ulkan energiya (qochish tezligi) va ilm kerak. Insoniyat bu chegarani ilm-fan orqaligina kesib o'tdi.",
                shape: 'ROCKET_LAUNCH'
            },
            {
                id: 29, surah: "Al-Ghashiyah 88:17",
                arabic: "Ø£ÙÙÙÙ„ÙØ§ ÙŠÙÙ†Ø¸ÙØ±ÙÙˆÙ†Ù Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¥ÙØ¨ÙÙ„Ù ÙƒÙÙŠÙ’ÙÙ Ø®ÙÙ„ÙÙ‚ÙØªÙ’",
                uzbek: "Tuyaga nazar solmaydilarmi, qanday yaratilgan?",
                source: "Zoologiya (Moslashuv)",
                hikmah: "Tuya sahro sharoitiga mukammal moslashgan bio-texnologiyadir. Suvsizlikka chidami, ko'z tuzilishi va oyoqlari qumda yurishga moslangan.",
                shape: 'DNA_BEAST'
            },
            {
                id: 30, surah: "Al-Mulk 67:19",
                arabic: "Ø£ÙÙˆÙÙ„ÙÙ…Ù’ ÙŠÙØ±ÙÙˆÙ’Ø§ Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ø·ÙÙ‘ÙŠÙ’Ø±Ù ÙÙÙˆÙ’Ù‚ÙÙ‡ÙÙ…Ù’ ØµÙØ§ÙÙÙ‘Ø§ØªÙ ÙˆÙÙŠÙÙ‚Ù’Ø¨ÙØ¶Ù’Ù†Ù",
                uzbek: "Tepalarida qanotlarini yoyib va yig'ib turgan qushlarni ko'rmadilarmi?",
                source: "Aerodinamika",
                hikmah: "Qushlarning parvozi samolyotlar ixtirosiga ilhom berdi. Bernoulli qonuni va qanot shakli havoda ko'tarilish kuchini hosil qiladi.",
                shape: 'WINGS'
            }
        ];

        // --- 2. AUDIO ENGINE (Sokin va Generativ) ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.mainGain = null;
                this.osc = null;
                this.filter = null;
            }

            init() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                
                this.mainGain = this.ctx.createGain();
                this.mainGain.gain.value = 0.05; // Juda past (sokin)
                this.mainGain.connect(this.ctx.destination);

                // Asosiy Ambient (Drone)
                this.osc = this.ctx.createOscillator();
                this.osc.type = 'sine';
                this.osc.frequency.value = 60; 
                
                this.filter = this.ctx.createBiquadFilter();
                this.filter.type = 'lowpass';
                this.filter.frequency.value = 100;

                this.osc.connect(this.filter);
                this.filter.connect(this.mainGain);
                this.osc.start();
            }

            // Qo'l harakati ovozni o'zgartiradi
            update(velocity) {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                // Harakat bo'lganda filtr ochiladi
                const targetFreq = 100 + (velocity * 400); 
                this.filter.frequency.setTargetAtTime(targetFreq, t, 0.2);
            }

            // Zikr tovushi (Yumshoq tomchi)
            playZikrSound() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.3);
                
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
                
                osc.connect(g);
                g.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.35);
            }

            // Oyat o'zgarganda (Shamol)
            playWhoosh() {
                if (!this.ctx) return;
                const noiseBuffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 1, this.ctx.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < noiseBuffer.length; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                const noise = this.ctx.createBufferSource();
                noise.buffer = noiseBuffer;
                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.value = 100;
                
                const noiseGain = this.ctx.createGain();
                noiseGain.gain.value = 0.05;

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.ctx.destination);
                
                noiseFilter.frequency.linearRampToValueAtTime(800, this.ctx.currentTime + 0.5);
                noiseGain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
                noise.start();
            }
        }

        // --- 3. PHYSICS & PARTICLES (Yangilangan Shakllar) ---
        class ParticleSystem {
            constructor(scene) {
                this.count = 8000; // Optimal son
                this.geometry = new THREE.BufferGeometry();
                this.positions = new Float32Array(this.count * 3);
                this.targetPositions = new Float32Array(this.count * 3);
                this.colors = new Float32Array(this.count * 3);
                this.originalColors = new Float32Array(this.count * 3);

                // Ranglar
                const colorGold = new THREE.Color(0xFFD700);
                const colorTeal = new THREE.Color(0x2dd4bf);
                const colorWhite = new THREE.Color(0xFFFFFF);

                for (let i = 0; i < this.count; i++) {
                    const i3 = i * 3;
                    this.positions[i3] = (Math.random() - 0.5) * 20;
                    this.positions[i3+1] = (Math.random() - 0.5) * 20;
                    this.positions[i3+2] = (Math.random() - 0.5) * 20;

                    let c = Math.random() > 0.5 ? colorTeal : colorGold;
                    if (Math.random() > 0.8) c = colorWhite;

                    this.colors[i3] = c.r;
                    this.colors[i3+1] = c.g;
                    this.colors[i3+2] = c.b;
                    
                    this.originalColors[i3] = c.r;
                    this.originalColors[i3+1] = c.g;
                    this.originalColors[i3+2] = c.b;
                }

                this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));
                this.geometry.setAttribute('color', new THREE.BufferAttribute(this.colors, 3));

                this.material = new THREE.PointsMaterial({
                    size: 0.06,
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    transparent: true,
                    opacity: 0.8
                });

                this.mesh = new THREE.Points(this.geometry, this.material);
                scene.add(this.mesh);
                
                this.generateShape('SPHERE');
            }

            generateShape(type) {
                const arr = this.targetPositions;
                const count = this.count;
                
                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    let x, y, z;
                    const idx = i / count;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);

                    switch(type) {
                        case 'DNA':
                            const h = (idx - 0.5) * 10;
                            const rDNA = 1.5;
                            const twist = h * 2;
                            // Double Helix
                            const strand = i % 2 === 0 ? 0 : Math.PI;
                            x = rDNA * Math.cos(twist + strand);
                            z = rDNA * Math.sin(twist + strand);
                            y = h;
                            // Random scatter around strand
                            x += (Math.random()-0.5)*0.2;
                            z += (Math.random()-0.5)*0.2;
                            break;
                            
                        case 'GALAXY':
                            const arms = 3;
                            const spin = idx * arms * Math.PI * 2;
                            const rGal = Math.pow(Math.random(), 0.5) * 5;
                            x = rGal * Math.cos(spin + rGal);
                            z = rGal * Math.sin(spin + rGal);
                            y = (Math.random() - 0.5) * (1 - rGal/5);
                            break;

                        case 'ATOM':
                            // Nucleus
                            if (i < count * 0.2) {
                                const rNuc = 0.5 * Math.cbrt(Math.random());
                                x = rNuc * Math.sin(phi) * Math.cos(theta);
                                y = rNuc * Math.sin(phi) * Math.sin(theta);
                                z = rNuc * Math.cos(phi);
                            } else {
                                // Electrons (Orbitals)
                                const rElec = 3 + Math.random();
                                const orbital = (i % 3) * (Math.PI / 3); // 3 planes
                                const ang = Math.random() * Math.PI * 2;
                                let tx = rElec * Math.cos(ang);
                                let ty = rElec * Math.sin(ang);
                                let tz = 0;
                                // Rotate orbital
                                x = tx * Math.cos(orbital) - tz * Math.sin(orbital);
                                y = ty;
                                z = tx * Math.sin(orbital) + tz * Math.cos(orbital);
                            }
                            break;

                        case 'TORUS': 
                            const R = 3; 
                            const rTube = 1;
                            const u = Math.random() * Math.PI * 2;
                            const v = Math.random() * Math.PI * 2;
                            x = (R + rTube * Math.cos(v)) * Math.cos(u);
                            y = (R + rTube * Math.cos(v)) * Math.sin(u);
                            z = rTube * Math.sin(v);
                            break;
                        
                        case 'CUBE':
                            const side = 4;
                            x = (Math.random() - 0.5) * side;
                            y = (Math.random() - 0.5) * side;
                            z = (Math.random() - 0.5) * side;
                            break;
                            
                        case 'WAVE':
                            x = (idx - 0.5) * 10;
                            z = (Math.random() - 0.5) * 6;
                            y = Math.sin(x + z) * 1.5;
                            break;

                        case 'NETWORK':
                            // Random points but clustered
                            if (Math.random() > 0.95) {
                                // Hubs
                                x = (Math.random() - 0.5) * 8;
                                y = (Math.random() - 0.5) * 8;
                                z = (Math.random() - 0.5) * 8;
                            } else {
                                // Lines/Connections (simplified as random cloud with structure)
                                const r = 5 * Math.cbrt(Math.random());
                                x = r * Math.sin(phi) * Math.cos(theta);
                                y = r * Math.sin(phi) * Math.sin(theta);
                                z = r * Math.cos(phi);
                            }
                            break;

                        case 'EXPANSION':
                        default: // SPHERE as default
                             const r = type === 'EXPANSION' ? Math.random() * 8 : 4 * Math.cbrt(Math.random());
                             x = r * Math.sin(phi) * Math.cos(theta);
                             y = r * Math.sin(phi) * Math.sin(theta);
                             z = r * Math.cos(phi);
                             break;
                    }

                    arr[i3] = x;
                    arr[i3+1] = y;
                    arr[i3+2] = z;
                }
            }

            update(zikrPulse) {
                const pos = this.geometry.attributes.position.array;
                const target = this.targetPositions;
                const speed = 0.04;

                for (let i = 0; i < this.count; i++) {
                    const i3 = i * 3;
                    
                    // Standard Movement
                    pos[i3] += (target[i3] - pos[i3]) * speed;
                    pos[i3+1] += (target[i3+1] - pos[i3+1]) * speed;
                    pos[i3+2] += (target[i3+2] - pos[i3+2]) * speed;

                    // ZIKR PULSE EFFECT
                    if (zikrPulse > 0) {
                        // Expand outward slightly on pulse
                        pos[i3] *= (1 + zikrPulse * 0.05);
                        pos[i3+1] *= (1 + zikrPulse * 0.05);
                        pos[i3+2] *= (1 + zikrPulse * 0.05);
                    }
                }
                this.geometry.attributes.position.needsUpdate = true;
                this.mesh.rotation.y += 0.002; // Sokin aylanish
            }
        }

        // --- 4. APP CONTROLLER ---
        class App {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.particles = null;
                this.audio = new AudioEngine();
                this.currentIndex = 0;
                
                // Hand Tracking Logic
                this.handDetected = false;
                this.isPinching = false;
                this.wasPinching = false;
                this.pinchDist = 1;
                
                // Zikr Logic
                this.zikrCounter = 0;
                this.zikrPulseFrame = 0;
            }

            start() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                document.getElementById('ui-layer').classList.add('visible');

                this.initThree();
                this.initMediaPipe();
                this.audio.init();
                this.updateUI();
            }

            initThree() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x000000, 0.06);

                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
                this.camera.position.z = 6;

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);

                this.particles = new ParticleSystem(this.scene);

                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Zikr Pulse Logic
                    let pulse = 0;
                    if (this.zikrPulseFrame > 0) {
                        pulse = Math.sin(this.zikrPulseFrame * 0.5); // Pulse wave
                        this.zikrPulseFrame -= 0.2;
                        if(this.zikrPulseFrame < 0) this.zikrPulseFrame = 0;
                    }

                    this.particles.update(pulse);
                    this.renderer.render(this.scene, this.camera);
                };
                animate();

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            initMediaPipe() {
                const videoElement = document.getElementById('input_video');
                const handStatus = document.getElementById('hand-status');
                const pinchStatus = document.getElementById('pinch-status');

                const hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults((results) => {
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        if (!this.handDetected) {
                            this.handDetected = true;
                            handStatus.innerText = "ULANDI";
                            handStatus.classList.remove('error');
                            handStatus.style.color = "#10b981";
                            handStatus.style.borderColor = "#10b981";
                        }

                        const lm = results.multiHandLandmarks[0];
                        const palm = lm[9];
                        const thumb = lm[4];
                        const indexF = lm[8];

                        // 1. Rotation Interaction
                        const rotX = (palm.y - 0.5) * 1.5; 
                        const rotY = (palm.x - 0.5) * 1.5;
                        this.scene.rotation.x += (rotX - this.scene.rotation.x) * 0.05;
                        this.scene.rotation.y += (rotY - this.scene.rotation.y) * 0.05;

                        // 2. Pinch Detection (Zikr Trigger)
                        const dist = Math.hypot(thumb.x - indexF.x, thumb.y - indexF.y);
                        this.isPinching = dist < 0.05; // Pinch threshold

                        if (this.isPinching && !this.wasPinching) {
                            // Pinch Endi boshlandi -> Zikr!
                            this.incrementZikr();
                            pinchStatus.style.color = "#34d399";
                            pinchStatus.style.fontWeight = "bold";
                            pinchStatus.innerText = "SUBHANALLOH";
                        } else if (!this.isPinching && this.wasPinching) {
                             pinchStatus.style.color = "#444";
                             pinchStatus.style.fontWeight = "normal";
                             pinchStatus.innerText = "ğŸ‘Œ BOSIB TURING";
                        }
                        this.wasPinching = this.isPinching;

                        // 3. Audio Update
                        const velocity = Math.abs(palm.x - 0.5); 
                        this.audio.update(velocity);

                    } else {
                        if (this.handDetected) {
                            this.handDetected = false;
                            handStatus.innerText = "QO'L IZLANMOQDA...";
                            handStatus.classList.add('error');
                        }
                    }
                });

                const camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({image: videoElement});
                    },
                    width: 640, height: 480, facingMode: "user"
                });
                camera.start();
            }

            incrementZikr() {
                this.zikrCounter++;
                document.getElementById('zikr-display').innerText = this.zikrCounter;
                
                // Vizual Pulse
                const zikrDisplay = document.getElementById('zikr-display');
                zikrDisplay.classList.remove('pulse-text');
                void zikrDisplay.offsetWidth; // Trigger reflow
                zikrDisplay.classList.add('pulse-text');

                // Physics Pulse Trigger
                this.zikrPulseFrame = Math.PI; // Start half-sine wave

                // Sound
                this.audio.playZikrSound();
            }

            resetZikr() {
                this.zikrCounter = 0;
                document.getElementById('zikr-display').innerText = 0;
            }

            nextAyah() {
                this.changeAyah((this.currentIndex + 1) % AYAHS.length);
            }

            prevAyah() {
                this.changeAyah((this.currentIndex - 1 + AYAHS.length) % AYAHS.length);
            }

            changeAyah(index) {
                // Fade out effect
                const wrapper = document.getElementById('content-box');
                wrapper.classList.add('fade-out');

                setTimeout(() => {
                    this.currentIndex = index;
                    this.updateUI();
                    this.particles.generateShape(AYAHS[this.currentIndex].shape || 'SPHERE');
                    this.audio.playWhoosh();
                    wrapper.classList.remove('fade-out');
                }, 500);
            }

            updateUI() {
                const data = AYAHS[this.currentIndex];
                document.getElementById('arabic').innerText = data.arabic;
                document.getElementById('uzbek').innerText = `"${data.uzbek}"`;
                document.getElementById('meta').innerText = data.surah;
                document.getElementById('hikmah-source').innerText = `â€” ${data.source}`;
                document.getElementById('hikmah-body').innerText = data.hikmah;
            }
        }

        // --- INIT ---
        const app = new App();
        document.getElementById('btn-start').addEventListener('click', () => app.start());

    </script>
</body>
</html>

