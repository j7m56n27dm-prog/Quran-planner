<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#022c22">
    <title>Nur Parvozi | Spiritual Focus & Hifz</title>
    <meta name="description" content="Qur'on tadabburi, hifz va ruhiy fokus uchun eng zamonaviy PWA.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600;800&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #10B981; /* Emerald */
            --primary-dark: #064E3B;
            --secondary: #F59E0B; /* Gold */
            --bg-deep: #022c22;
            --bg-glass: rgba(6, 78, 59, 0.6);
            --text-light: #ECFDF5;
            --text-gold: #FEF3C7;
            --danger: #EF4444;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow-neon: 0 0 20px rgba(16, 185, 129, 0.3);
            --font-main: 'Inter', sans-serif;
            --font-arabic: 'Amiri', serif;
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        [data-theme="light"] {
            --bg-deep: #F0FDF4;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --text-light: #064E3B;
            --shadow-neon: 0 0 15px rgba(16, 185, 129, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-light);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(16, 185, 129, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 40%);
            transition: background 0.5s ease;
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .btn-nur {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: var(--shadow-neon);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s var(--ease-elastic);
        }

        .btn-nur:active {
            transform: scale(0.95);
        }

        .btn-nur::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .btn-nur:hover::after { opacity: 1; }

        /* --- LAYOUT --- */
        #app {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 90px; /* Space for nav */
            scroll-behavior: smooth;
        }

        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(2, 44, 34, 0.8);
            backdrop-filter: blur(10px);
        }

        .logo-area h1 {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.4s ease forwards;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(6, 78, 59, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
            z-index: 200;
        }

        .nav-item {
            color: rgba(255,255,255,0.5);
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            display: block;
        }

        .nav-item.active {
            color: var(--secondary);
            transform: translateY(-5px);
        }

        .nav-item.active i {
            text-shadow: 0 0 10px var(--secondary);
        }

        /* --- DASHBOARD --- */
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .mood-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .mood-card.selected {
            border-color: var(--secondary);
            background: rgba(245, 158, 11, 0.1);
        }

        .mood-emoji { font-size: 1.8rem; display: block; margin-bottom: 5px; }

        .daily-wisdom {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(0,0,0,0));
            border-left: 4px solid var(--secondary);
            margin-top: 20px;
            position: relative;
        }
        
        .arabic-text {
            font-family: var(--font-arabic);
            font-size: 1.6rem;
            line-height: 1.8;
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-gold);
        }

        /* --- FOCUS / FLIGHT MODE --- */
        .focus-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 40px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .focus-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .focus-circle-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
        .focus-circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-dasharray: 880;
            stroke-dashoffset: 880;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 5px var(--primary));
        }

        .focus-center {
            position: absolute;
            text-align: center;
            width: 70%;
        }

        .timer-display { font-size: 3rem; font-weight: 800; font-variant-numeric: tabular-nums; }
        
        .flight-animation {
            position: absolute;
            top: -50px; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }
        
        .plane-icon {
            font-size: 2rem;
            color: var(--secondary);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 1s linear;
            text-shadow: 0 0 15px var(--secondary);
        }

        /* --- HIFZ SECTION --- */
        .hifz-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            flex: 1;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        .surah-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .surah-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border-left: 3px solid #555;
        }
        
        .surah-item.weak { border-left-color: var(--danger); }
        .surah-item.review { border-left-color: var(--secondary); }
        .surah-item.strong { border-left-color: var(--primary); }

        /* --- DISTRACTION SHIELD --- */
        #distraction-shield {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
        }
        
        .shield-content h2 { font-size: 2rem; color: var(--secondary); margin-bottom: 20px; }
        .pulse-breathing {
            width: 100px; height: 100px;
            background: var(--primary);
            border-radius: 50%;
            margin: 30px auto;
            animation: breathe 4s infinite ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); opacity: 0.4; }
        }

        /* --- CANVAS GENERATOR --- */
        #share-canvas { display: none; }

        /* RTL Handling */
        [dir="rtl"] { font-family: 'Noto Sans Arabic', sans-serif; }
        [dir="rtl"] .daily-wisdom { border-left: none; border-right: 4px solid var(--secondary); }

        .creator-tag {
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.4;
            margin-top: 30px;
        }
    </style>
</head>
<body data-theme="dark">

    <div id="app">
        <!-- HEADER -->
        <header>
            <div class="logo-area" onclick="app.toggleLang()">
                <h1>Nur Parvozi ‚úàÔ∏è</h1>
            </div>
            <div class="user-stats">
                <span id="streak-display">üî• 0</span>
                <i class="fas fa-cog" style="margin-left: 15px; cursor:pointer" onclick="app.navTo('settings')"></i>
            </div>
        </header>

        <!-- HOME TAB -->
        <section id="home" class="section active">
            <div class="glass-panel" style="margin-bottom: 20px;">
                <h3 id="greeting">Assalomu alaykum</h3>
                <p style="opacity: 0.7; font-size: 0.9rem;">Qalbingiz holati qanday?</p>
                <div class="mood-grid">
                    <div class="mood-card" onclick="app.setMood('happy')">
                        <span class="mood-emoji">üòä</span>
                        <span data-i18n="mood_happy">Shukr</span>
                    </div>
                    <div class="mood-card" onclick="app.setMood('anxious')">
                        <span class="mood-emoji">üò∞</span>
                        <span data-i18n="mood_anxious">Xavotir</span>
                    </div>
                    <div class="mood-card" onclick="app.setMood('lazy')">
                        <span class="mood-emoji">ü•±</span>
                        <span data-i18n="mood_lazy">G'aflat</span>
                    </div>
                    <div class="mood-card" onclick="app.setMood('sinful')">
                        <span class="mood-emoji">üíî</span>
                        <span data-i18n="mood_sinful">Tavba</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel daily-wisdom">
                <div id="wisdom-content">
                    <div class="arabic-text" id="quote-arabic"></div>
                    <p id="quote-trans" style="font-style: italic; margin-bottom: 10px;"></p>
                    <p id="quote-source" style="text-align: right; font-weight: bold; color: var(--secondary);"></p>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn-nur" style="padding: 8px 15px; font-size: 0.8rem;" onclick="app.speakQuote()"><i class="fas fa-volume-up"></i></button>
                    <button class="btn-nur" style="padding: 8px 15px; font-size: 0.8rem;" onclick="app.shareCard()"><i class="fas fa-share-alt"></i></button>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3 data-i18n="quick_actions">Tezkor Amallar</h3>
                <div style="display: flex; gap: 10px; margin-top: 10px; overflow-x: auto;">
                    <div class="glass-panel" style="min-width: 140px; text-align: center;" onclick="app.navTo('focus')">
                        <i class="fas fa-plane-departure" style="font-size: 1.5rem; color: var(--primary); margin-bottom: 5px;"></i>
                        <div data-i18n="nav_focus">Nur Parvozi</div>
                    </div>
                    <div class="glass-panel" style="min-width: 140px; text-align: center;" onclick="app.navTo('hifz')">
                        <i class="fas fa-book-quran" style="font-size: 1.5rem; color: var(--secondary); margin-bottom: 5px;"></i>
                        <div data-i18n="nav_hifz">Hifz</div>
                    </div>
                </div>
            </div>
            
            <div class="creator-tag">Made by ¬© Muhammad Daler</div>
        </section>

        <!-- HIFZ TAB -->
        <section id="hifz" class="section">
            <h2 data-i18n="hifz_title" style="margin-bottom: 15px;">Mening Qur'onim</h2>
            <div class="hifz-stats">
                <div class="stat-box">
                    <div class="stat-val" id="hifz-count">0</div>
                    <div style="font-size: 0.8rem;">Surahs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="hifz-review" style="color: var(--secondary)">0</div>
                    <div style="font-size: 0.8rem;">Review Due</div>
                </div>
            </div>
            <button class="btn-nur" style="width: 100%; margin-bottom: 20px;" onclick="app.addHifz()">+ Add New Surah</button>
            <div class="surah-list" id="surah-container">
                <!-- JS Populates this -->
            </div>
        </section>

        <!-- FOCUS TAB -->
        <section id="focus" class="section">
            <h2 style="text-align: center; margin-bottom: 10px;" data-i18n="focus_journey">Jannat Tomon Parvoz</h2>
            <p style="text-align: center; opacity: 0.7; font-size: 0.9rem;" id="focus-subtitle">Niyyatni yangilang va parvozni boshlang.</p>
            
            <div class="focus-circle-container">
                <div class="flight-animation"></div>
                <svg class="focus-svg">
                    <circle class="focus-circle-bg" cx="140" cy="140" r="135"></circle>
                    <circle class="focus-circle-progress" id="progress-ring" cx="140" cy="140" r="135"></circle>
                </svg>
                <div class="focus-center">
                    <div class="timer-display" id="timer">25:00</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; color: var(--secondary);">Zikr Mode</div>
                </div>
                <i class="fas fa-plane plane-icon" id="plane-indicator"></i>
            </div>

            <div style="display: flex; justify-content: center; gap: 20px;">
                <button class="btn-nur" id="start-btn" onclick="focusMode.toggle()"><i class="fas fa-play"></i> Boshlash</button>
            </div>
        </section>

        <!-- SETTINGS TAB -->
        <section id="settings" class="section">
            <h2 data-i18n="settings">Sozlamalar</h2>
            <div class="glass-panel" style="margin-top: 20px;">
                <div class="surah-item" onclick="app.changeLang('uz')">üá∫üáø O'zbekcha</div>
                <div class="surah-item" onclick="app.changeLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
                <div class="surah-item" onclick="app.changeLang('en')">üá¨üáß English</div>
                <div class="surah-item" onclick="app.changeLang('ar')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                <br>
                <div class="surah-item" onclick="app.resetData()" style="border-left-color: red;">‚ö†Ô∏è Reset Data</div>
            </div>
        </section>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-target="home" onclick="app.navTo('home')">
            <i class="fas fa-home"></i>
            <span data-i18n="nav_home">Asosiy</span>
        </div>
        <div class="nav-item" data-target="hifz" onclick="app.navTo('hifz')">
            <i class="fas fa-book-open"></i>
            <span data-i18n="nav_hifz">Hifz</span>
        </div>
        <div class="nav-item" data-target="focus" onclick="app.navTo('focus')">
            <i class="fas fa-mosque"></i>
            <span data-i18n="nav_focus">Parvoz</span>
        </div>
    </nav>

    <!-- DISTRACTION SHIELD OVERLAY -->
    <div id="distraction-shield">
        <div class="shield-content">
            <h2>SubhanAllah!</h2>
            <p>Siz "Nur Parvozi"dan chalg'idingiz.</p>
            <p>Qaytish uchun 3 marta chuqur nafas oling.</p>
            <div class="pulse-breathing" id="breath-counter">3</div>
            <button class="btn-nur" style="margin-top: 20px; background: transparent; border: 1px solid var(--secondary);" onclick="shield.dismiss()">Qaytish</button>
        </div>
    </div>

    <canvas id="share-canvas" width="1080" height="1080"></canvas>

    <script>
        /* --- DATA & CONTENT --- */
        const DB = {
            uz: {
                nav_home: "Asosiy", nav_hifz: "Hifz", nav_focus: "Parvoz",
                mood_happy: "Shukr", mood_anxious: "Xavotir", mood_lazy: "G'aflat", mood_sinful: "Tavba",
                hifz_title: "Hifz Murabbiyi",
                quotes: {
                    happy: { ar: "ŸÑŸéÿ¶ŸêŸÜ ÿ¥ŸéŸÉŸéÿ±Ÿíÿ™ŸèŸÖŸí ŸÑŸéÿ£Ÿéÿ≤ŸêŸäÿØŸéŸÜŸéŸëŸÉŸèŸÖŸí", tr: "Qasamki, agar shukr qilsangiz, albatta, sizga ziyoda qilurman.", src: "Ibrohim, 7" },
                    anxious: { ar: "ÿ£ŸéŸÑŸéÿß ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê Ÿ±ŸÑŸÑŸéŸëŸáŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë Ÿ±ŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿè", tr: "Ogoh bo'lingkim, Allohni zikr etish bilan qalblar orom olur.", src: "Ra'd, 28" },
                    lazy: { ar: "ŸàŸéÿ≥Ÿéÿßÿ±ŸêÿπŸèŸàŸìÿß€ü ÿ•ŸêŸÑŸéŸâŸ∞ ŸÖŸéÿ∫ŸíŸÅŸêÿ±Ÿéÿ©Ÿç ŸÖŸêŸëŸÜ ÿ±ŸéŸëÿ®ŸêŸëŸÉŸèŸÖŸí", tr: "Robbingizdan bo'lgan mag'firatga shoshiling!", src: "Oli Imron, 133" },
                    sinful: { ar: "ÿ•ŸêŸÜŸéŸë Ÿ±ŸÑŸÑŸéŸëŸáŸé ŸäŸèÿ≠Ÿêÿ®ŸèŸë Ÿ±ŸÑÿ™ŸéŸëŸàŸéŸëŸ∞ÿ®ŸêŸäŸÜŸé", tr: "Albatta, Alloh tavba qiluvchilarni sevadi.", src: "Baqara, 222" }
                }
            },
            en: {
                nav_home: "Home", nav_hifz: "Hifz", nav_focus: "Flight",
                mood_happy: "Grateful", mood_anxious: "Anxious", mood_lazy: "Lazy", mood_sinful: "Regret",
                hifz_title: "Hifz Coach",
                quotes: {
                    happy: { ar: "ŸÑŸéÿ¶ŸêŸÜ ÿ¥ŸéŸÉŸéÿ±Ÿíÿ™ŸèŸÖŸí ŸÑŸéÿ£Ÿéÿ≤ŸêŸäÿØŸéŸÜŸéŸëŸÉŸèŸÖŸí", tr: "If you are grateful, I will surely increase you [in favor].", src: "Ibrahim, 7" },
                    anxious: { ar: "ÿ£ŸéŸÑŸéÿß ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê Ÿ±ŸÑŸÑŸéŸëŸáŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë Ÿ±ŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿè", tr: "Unquestionably, by the remembrance of Allah do hearts find rest.", src: "Ra'd, 28" }
                }
            },
            ru: {
                nav_home: "–ì–ª–∞–≤–Ω–∞—è", nav_hifz: "–•–∏—Ñ–∑", nav_focus: "–ü–æ–ª–µ—Ç",
                mood_happy: "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", mood_anxious: "–¢—Ä–µ–≤–æ–≥–∞", mood_lazy: "–õ–µ–Ω—å", mood_sinful: "–ü–æ–∫–∞—è–Ω–∏–µ",
                hifz_title: "–•–∏—Ñ–∑ –¢—Ä–µ–Ω–µ—Ä",
                quotes: {
                    happy: { ar: "ŸÑŸéÿ¶ŸêŸÜ ÿ¥ŸéŸÉŸéÿ±Ÿíÿ™ŸèŸÖŸí ŸÑŸéÿ£Ÿéÿ≤ŸêŸäÿØŸéŸÜŸéŸëŸÉŸèŸÖŸí", tr: "–ï—Å–ª–∏ –≤—ã –±—É–¥–µ—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã, —Ç–æ –Ø –æ–¥–∞—Ä—é –≤–∞—Å –µ—â–µ –±–æ–ª—å—à–∏–º–∏ –±–ª–∞–≥–∞–º–∏.", src: "–ò–±—Ä–∞—Ö–∏–º, 7" },
                    anxious: { ar: "ÿ£ŸéŸÑŸéÿß ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê Ÿ±ŸÑŸÑŸéŸëŸáŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë Ÿ±ŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿè", tr: "–†–∞–∑–≤–µ –Ω–µ –ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –ê–ª–ª–∞—Ö–∞ —É—Ç–µ—à–∞—é—Ç—Å—è —Å–µ—Ä–¥—Ü–∞?", src: "–ê—Ä-–†–∞–∞–¥, 28" }
                }
            },
            ar: {
                nav_home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", nav_hifz: "ÿßŸÑÿ≠ŸÅÿ∏", nav_focus: "ÿ™ÿ≠ŸÑŸäŸÇ",
                mood_happy: "ÿ¥ŸÉÿ±", mood_anxious: "ŸÇŸÑŸÇ", mood_lazy: "ÿ∫ŸÅŸÑÿ©", mood_sinful: "ÿ™Ÿàÿ®ÿ©",
                hifz_title: "ŸÖÿØÿ±ÿ® ÿßŸÑÿ≠ŸÅÿ∏",
                quotes: {
                    happy: { ar: "ŸÑŸéÿ¶ŸêŸÜ ÿ¥ŸéŸÉŸéÿ±Ÿíÿ™ŸèŸÖŸí ŸÑŸéÿ£Ÿéÿ≤ŸêŸäÿØŸéŸÜŸéŸëŸÉŸèŸÖŸí", tr: "ŸÑŸéÿ¶ŸêŸÜ ÿ¥ŸéŸÉŸéÿ±Ÿíÿ™ŸèŸÖŸí ŸÑŸéÿ£Ÿéÿ≤ŸêŸäÿØŸéŸÜŸéŸëŸÉŸèŸÖŸí", src: "ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ Ÿß" },
                    anxious: { ar: "ÿ£ŸéŸÑŸéÿß ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê Ÿ±ŸÑŸÑŸéŸëŸáŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë Ÿ±ŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿè", tr: "ÿ£ŸéŸÑŸéÿß ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê Ÿ±ŸÑŸÑŸéŸëŸáŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë Ÿ±ŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿè", src: "ÿßŸÑÿ±ÿπÿØ Ÿ¢Ÿ®" }
                }
            }
        };

        /* --- STATE & STORAGE --- */
        class AppState {
            constructor() {
                this.lang = localStorage.getItem('np_lang') || 'uz';
                this.mood = 'happy';
                this.streak = parseInt(localStorage.getItem('np_streak') || 0);
                this.hifzData = JSON.parse(localStorage.getItem('np_hifz') || '[]');
                this.theme = 'dark';
            }
            
            save() {
                localStorage.setItem('np_lang', this.lang);
                localStorage.setItem('np_streak', this.streak);
                localStorage.setItem('np_hifz', JSON.stringify(this.hifzData));
            }
        }

        const state = new AppState();

        /* --- MAIN APP LOGIC --- */
        const app = {
            init: () => {
                app.applyLang();
                app.renderHifz();
                app.updateQuote();
                document.getElementById('streak-display').innerText = `üî• ${state.streak}`;
                
                // Fallback for missing keys in other langs
                if(!DB[state.lang].quotes.lazy) DB[state.lang].quotes.lazy = DB['uz'].quotes.lazy;
                if(!DB[state.lang].quotes.sinful) DB[state.lang].quotes.sinful = DB['uz'].quotes.sinful;
            },

            navTo: (pageId) => {
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`.nav-item[data-target="${pageId}"]`).classList.add('active');
            },

            setMood: (mood) => {
                state.mood = mood;
                document.querySelectorAll('.mood-card').forEach(el => el.classList.remove('selected'));
                event.currentTarget.classList.add('selected');
                
                // Change theme hue based on mood
                const root = document.documentElement;
                if(mood === 'anxious') root.style.setProperty('--primary', '#3B82F6'); // Blue
                else if(mood === 'sinful') root.style.setProperty('--primary', '#8B5CF6'); // Purple
                else if(mood === 'lazy') root.style.setProperty('--primary', '#EF4444'); // Red
                else root.style.setProperty('--primary', '#10B981'); // Emerald
                
                app.updateQuote();
            },

            updateQuote: () => {
                const q = DB[state.lang].quotes[state.mood] || DB[state.lang].quotes.happy;
                document.getElementById('quote-arabic').innerText = q.ar;
                document.getElementById('quote-trans').innerText = q.tr;
                document.getElementById('quote-source').innerText = q.src;
            },

            changeLang: (lang) => {
                state.lang = lang;
                state.save();
                location.reload();
            },

            applyLang: () => {
                const t = DB[state.lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if(t[key]) el.innerText = t[key];
                });
                
                if(state.lang === 'ar') document.body.setAttribute('dir', 'rtl');
                else document.body.setAttribute('dir', 'ltr');
            },

            speakQuote: () => {
                const q = DB[state.lang].quotes[state.mood];
                const utterance = new SpeechSynthesisUtterance(q.ar);
                utterance.lang = 'ar-SA';
                speechSynthesis.speak(utterance);
            },
            
            resetData: () => {
                if(confirm('Are you sure? All progress will be lost.')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            // --- CANVAS SHARE ---
            shareCard: () => {
                const canvas = document.getElementById('share-canvas');
                const ctx = canvas.getContext('2d');
                const q = DB[state.lang].quotes[state.mood];

                // Draw BG
                const grad = ctx.createLinearGradient(0,0, 1080, 1080);
                grad.addColorStop(0, '#064E3B');
                grad.addColorStop(1, '#022c22');
                ctx.fillStyle = grad;
                ctx.fillRect(0,0, 1080, 1080);

                // Draw Text
                ctx.fillStyle = '#F59E0B';
                ctx.font = 'bold 80px Amiri';
                ctx.textAlign = 'center';
                wrapText(ctx, q.ar, 540, 400, 900, 100);

                ctx.fillStyle = '#fff';
                ctx.font = 'italic 50px Inter';
                wrapText(ctx, q.tr, 540, 700, 900, 70);

                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '40px Inter';
                ctx.fillText(`Nur Parvozi App ‚Ä¢ ${q.src}`, 540, 950);

                // Download
                const link = document.createElement('a');
                link.download = 'nur-parvozi-hikmat.png';
                link.href = canvas.toDataURL();
                link.click();
            },

            // --- HIFZ LOGIC (Simplified Spaced Repetition) ---
            addHifz: () => {
                const name = prompt("Surah Name (e.g. Yasin):");
                if(!name) return;
                state.hifzData.push({ 
                    id: Date.now(), 
                    name, 
                    level: 0, // 0=New, 5=Mastered
                    nextReview: Date.now() 
                });
                state.save();
                app.renderHifz();
            },

            renderHifz: () => {
                const container = document.getElementById('surah-container');
                container.innerHTML = '';
                let reviewCount = 0;
                
                state.hifzData.forEach(item => {
                    const isDue = Date.now() >= item.nextReview;
                    if(isDue) reviewCount++;
                    
                    const div = document.createElement('div');
                    div.className = `surah-item ${isDue ? 'review' : (item.level > 3 ? 'strong' : 'weak')}`;
                    div.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${isDue ? 'Review Now!' : 'Next: ' + new Date(item.nextReview).toLocaleDateString()}</small>
                        </div>
                        <button class="btn-nur" style="padding: 5px 10px; font-size: 0.7rem;" onclick="app.reviewSurah(${item.id})">‚úÖ</button>
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('hifz-count').innerText = state.hifzData.length;
                document.getElementById('hifz-review').innerText = reviewCount;
            },

            reviewSurah: (id) => {
                const idx = state.hifzData.findIndex(x => x.id === id);
                const item = state.hifzData[idx];
                
                // Simple Algorithm: Level increases, interval doubles
                item.level++;
                const daysToAdd = Math.pow(2, item.level); // 1, 2, 4, 8, 16 days
                item.nextReview = Date.now() + (daysToAdd * 24 * 60 * 60 * 1000);
                
                state.streak++;
                state.save();
                app.renderHifz();
                app.init(); // update streak UI
                alert(`MashaAllah! Next review in ${daysToAdd} days.`);
            }
        };

        // Helper for Canvas
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            let words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }

        /* --- FOCUS MODE LOGIC --- */
        const focusMode = {
            timer: null,
            timeLeft: 1500, // 25 min
            isActive: false,

            toggle: () => {
                if(focusMode.isActive) focusMode.stop();
                else focusMode.start();
            },

            start: () => {
                focusMode.isActive = true;
                document.getElementById('start-btn').innerHTML = '<i class="fas fa-pause"></i> Pause';
                shield.activate(); // Activate distraction shield logic
                
                focusMode.timer = setInterval(() => {
                    focusMode.timeLeft--;
                    focusMode.updateUI();
                    
                    if(focusMode.timeLeft <= 0) {
                        focusMode.stop();
                        alert("Alhamdulillah! Session Complete.");
                        state.streak += 5;
                        state.save();
                        app.init();
                    }
                }, 1000);
            },

            stop: () => {
                focusMode.isActive = false;
                clearInterval(focusMode.timer);
                document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> Resume';
                shield.deactivate();
            },

            updateUI: () => {
                const mins = Math.floor(focusMode.timeLeft / 60);
                const secs = focusMode.timeLeft % 60;
                document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                
                // Animate Ring
                const total = 1500;
                const offset = 880 - (880 * ((total - focusMode.timeLeft) / total));
                document.getElementById('progress-ring').style.strokeDashoffset = offset;
                
                // Move Plane
                const percent = (total - focusMode.timeLeft) / total * 100;
                document.getElementById('plane-indicator').style.bottom = `${20 + (percent * 2)}px`; // Simple vertical movement for demo
            }
        };

        /* --- DISTRACTION SHIELD --- */
        const shield = {
            active: false,
            
            activate: () => {
                shield.active = true;
                document.addEventListener('visibilitychange', shield.check);
            },
            
            deactivate: () => {
                shield.active = false;
                document.removeEventListener('visibilitychange', shield.check);
            },
            
            check: () => {
                if(document.hidden && shield.active && focusMode.isActive) {
                    // User left the app while focused!
                    setTimeout(() => {
                        // Check if they are still gone after 1s (to avoid accidental swipes)
                        if(document.hidden) {
                            shield.showOverlay();
                        }
                    }, 500);
                }
            },
            
            showOverlay: () => {
                const el = document.getElementById('distraction-shield');
                el.style.display = 'flex';
                // Play subtle beep or vibrate
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            },
            
            dismiss: () => {
                // Breathing exercise logic
                let count = 3;
                const counterEl = document.getElementById('breath-counter');
                const btn = event.target;
                btn.disabled = true;
                btn.innerText = "Nafas oling...";
                
                const interval = setInterval(() => {
                    count--;
                    counterEl.innerText = count;
                    if(count <= 0) {
                        clearInterval(interval);
                        document.getElementById('distraction-shield').style.display = 'none';
                        btn.disabled = false;
                        btn.innerText = "Qaytish";
                        counterEl.innerText = "3";
                    }
                }, 1500);
            }
        };

        // Init App
        window.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>

