import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, Pause, RotateCcw, CheckCircle2, LayoutGrid, 
  BarChart2, Settings, Clock, Calendar, ChevronRight, 
  BookOpen, Wind, Brain, Volume2, X, Plus, Trophy
} from 'lucide-react';

/** --- DATA & CONTENT --- */
const HIKMATLAR = [
  "Agar Qur'on sening qalbingda bo'lsa, qayerda bo'lishingdan qat'iy nazar, Alloh sen bilan.",
  "Ilm o'rganish igna bilan quduq qazish kabidir, sabr qil va natijani Allohdan so'ra.",
  "Vaqtingni bekorga sarflama, chunki o'tgan vaqt qaytib kelmaydi.",
  "Qur'on o'quvchi xor bo'lmas.",
  "Bugungi vazifani ertaga qoldirma, ertaga boshqa vazifalar ham bo'ladi.",
  "Yodlash qiyin bo'lsa, gunohlarni tark etish bilan yengilla.",
  "Muvaffaqiyat siri — davomiylikdadir.",
  "Har bir harf uchun o'n savob bor. Bu savdo faqat Alloh bilandir.",
];

const MASLAHATLAR = [
  "Telefoningizni 'Bezovta qilinmasin' rejimiga qo'ying.",
  "Mushafga qarab o'qish xotirani kuchaytiradi.",
  "Ovoz chiqarib o'qish diqqatni jamlashga yordam beradi.",
  "Har 25 daqiqada suv ichishni unutmang, miya suvni yaxshi ko'radi.",
  "Darsni tongda, miya tiniq paytda qilishga harakat qiling."
];

/** --- UTILS --- */
const formatTime = (seconds) => {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
};

const playNotificationSound = () => {
  // Oddiy "beep" ovozi brauzer orqali
  try {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
  } catch (e) {
    console.error("Audio error:", e);
  }
};

/** --- COMPONENTS --- */

// 1. INTRO SCREEN (NIYAT)
const IntroScreen = ({ onStart }) => {
  return (
    <div className="fixed inset-0 z-50 bg-[#050505] flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-1000">
      <div className="mb-8 relative">
        <div className="absolute inset-0 bg-amber-500 blur-[60px] opacity-20 rounded-full animate-pulse"></div>
        <BookOpen size={64} className="text-amber-400 relative z-10" />
      </div>
      <h1 className="text-2xl font-bold text-white mb-6 leading-relaxed font-serif">
        "Allohning roziligi uchun Qur'onni takrorlashga va o'rganishga tayyorman"
      </h1>
      <button 
        onClick={onStart}
        className="px-8 py-3 bg-gradient-to-r from-amber-500 to-orange-600 rounded-full text-black font-bold text-lg hover:scale-105 active:scale-95 transition-transform shadow-[0_0_20px_rgba(245,158,11,0.3)]"
      >
        Bismilloh, Boshladim
      </button>
      <div className="mt-12 text-white/20 text-xs">
        Made by ©️Muhammad Daler
      </div>
    </div>
  );
};

// 2. BREATHING EXERCISE
const BreathingExercise = ({ onFinish }) => {
  const [phase, setPhase] = useState('Nafas oling'); // Nafas oling, Ushlab turing, Chiqaring
  const [timeLeft, setTimeLeft] = useState(4); // 4-7-8 technique

  useEffect(() => {
    // Simple 4-7-8 cycle logic simulation for demo
    const cycle = async () => {
      setPhase('Nafas oling (Burundan)');
      await new Promise(r => setTimeout(r, 4000));
      setPhase('Ushlab turing');
      await new Promise(r => setTimeout(r, 7000));
      setPhase('Chiqaring (Og\'izdan)');
      await new Promise(r => setTimeout(r, 8000));
      onFinish();
    };
    cycle();
  }, []);

  return (
    <div className="absolute inset-0 bg-black/90 backdrop-blur-xl z-40 flex flex-col items-center justify-center animate-in fade-in">
      <h2 className="text-xl text-white mb-8 font-medium">Diqqatni jamlash mashqi</h2>
      
      <div className="relative flex items-center justify-center">
        <div className={`w-48 h-48 rounded-full border-2 border-emerald-500/30 absolute transition-all duration-[4000ms] ease-in-out ${phase.includes('oling') ? 'scale-150 opacity-50' : 'scale-100 opacity-20'}`}></div>
        <div className={`w-32 h-32 bg-emerald-500 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(16,185,129,0.5)] transition-all duration-[4000ms] ease-in-out ${phase.includes('oling') ? 'scale-125' : phase.includes('Chiqaring') ? 'scale-75' : 'scale-100'}`}>
          <Wind size={32} className="text-black" />
        </div>
      </div>

      <p className="mt-12 text-2xl font-bold text-emerald-400 animate-pulse">{phase}</p>
      <button onClick={onFinish} className="mt-8 text-white/40 text-sm hover:text-white underline">
        Mashqni o'tkazib yuborish
      </button>
    </div>
  );
};

// 3. MAIN APP
const App = () => {
  const [appState, setAppState] = useState('intro'); // intro, app
  const [activeTab, setActiveTab] = useState('focus');
  const [showBreathing, setShowBreathing] = useState(false);
  
  // -- TIMER STATE --
  const [timerActive, setTimerActive] = useState(false);
  const [timerMode, setTimerMode] = useState('focus'); // focus, break
  const [focusDuration, setFocusDuration] = useState(25);
  const [breakDuration, setBreakDuration] = useState(5);
  const [timeLeft, setTimeLeft] = useState(25 * 60);
  const timerRef = useRef(null);

  // -- TASKS & STATS --
  const [tasks, setTasks] = useState([]);
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [stats, setStats] = useState({ totalMinutes: 0, streak: 0, lastActive: '' });
  const [showConfetti, setShowConfetti] = useState(false);
  const [randomQuote, setRandomQuote] = useState(HIKMATLAR[0]);

  // -- INIT --
  useEffect(() => {
    const savedTasks = JSON.parse(localStorage.getItem('q_tasks') || '[]');
    const savedStats = JSON.parse(localStorage.getItem('q_stats') || '{"totalMinutes":0,"streak":0,"lastActive":""}');
    setTasks(savedTasks);
    setStats(savedStats);
    
    // Request Notification Permission on load
    if ('Notification' in window) {
      Notification.requestPermission();
    }
  }, []);

  // -- SAVE --
  useEffect(() => {
    localStorage.setItem('q_tasks', JSON.stringify(tasks));
    localStorage.setItem('q_stats', JSON.stringify(stats));
  }, [tasks, stats]);

  // -- TIMER LOGIC --
  useEffect(() => {
    if (timerActive && timeLeft > 0) {
      timerRef.current = setInterval(() => {
        setTimeLeft(prev => prev - 1);
      }, 1000);
    } else if (timeLeft === 0 && timerActive) {
      handleTimerComplete();
    }
    return () => clearInterval(timerRef.current);
  }, [timerActive, timeLeft]);

  const handleTimerComplete = () => {
    setTimerActive(false);
    playNotificationSound();
    
    // System Notification
    if (Notification.permission === 'granted') {
      new Notification(timerMode === 'focus' ? "MashaaAlloh! Vaqt tugadi." : "Dam olish tugadi!", {
        body: timerMode === 'focus' ? "Darsni tugatdingiz. Endi biroz dam oling." : "Yana ilm olishga qaytamiz!",
        icon: "/icon.png"
      });
    }

    if (timerMode === 'focus') {
      // Update Stats
      const newStats = { ...stats, totalMinutes: stats.totalMinutes + focusDuration };
      setStats(newStats);
      setShowConfetti(true);
      setTimeout(() => setShowConfetti(false), 5000);
      setRandomQuote(HIKMATLAR[Math.floor(Math.random() * HIKMATLAR.length)]);
      
      // Avto Breakga o'tishni taklif qilish mumkin, hozircha qo'lda
      alert(`Vaqt tugadi! \n\nHikmat: ${randomQuote}`);
    } else {
      alert("Dam olish vaqti tugadi. Bismilloh, davom ettiramiz!");
    }
  };

  const toggleTimer = () => {
    if (!timerActive && timerMode === 'focus' && timeLeft === focusDuration * 60) {
      // Start bosilganda birinchi marta Breathing mashqini taklif qilish
      if (!showBreathing) {
        // Logika: User xohlasa breathing qiladi, biz shunchaki timer yoqamiz
      }
    }
    setTimerActive(!timerActive);
  };

  const resetTimer = () => {
    setTimerActive(false);
    setTimeLeft(timerMode === 'focus' ? focusDuration * 60 : breakDuration * 60);
  };

  const changeMode = (mode) => {
    setTimerMode(mode);
    setTimerActive(false);
    setTimeLeft(mode === 'focus' ? focusDuration * 60 : breakDuration * 60);
  };

  // -- TASK HANDLERS --
  const addTask = () => {
    if (!newTaskTitle.trim()) return;
    setTasks([...tasks, { id: Date.now(), title: newTaskTitle, completed: false }]);
    setNewTaskTitle('');
  };

  const toggleTask = (id) => {
    setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
    if (navigator.vibrate) navigator.vibrate(20);
  };

  const startFocusWithBreathing = () => {
    setShowBreathing(true);
  };

  const onBreathingFinish = () => {
    setShowBreathing(false);
    setTimerActive(true); // Avtomatik timerni boshlash
  };

  // --- RENDER ---

  if (appState === 'intro') {
    return <IntroScreen onStart={() => setAppState('app')} />;
  }

  return (
    <div className="min-h-screen bg-[#09090b] text-white font-sans overflow-hidden selection:bg-amber-500/30">
      
      {/* Dynamic Ambient Background */}
      <div className="fixed inset-0 pointer-events-none">
        <div className={`absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b ${timerActive ? 'from-amber-900/10' : 'from-blue-900/10'} to-transparent transition-colors duration-1000`}></div>
      </div>

      {showBreathing && <BreathingExercise onFinish={onBreathingFinish} />}

      {/* --- CONTENT --- */}
      <main className="relative z-10 h-screen flex flex-col pb-24 overflow-y-auto">
        
        {/* HEADER */}
        <header className="px-6 py-4 flex justify-between items-center bg-white/5 backdrop-blur-md sticky top-0 z-20 border-b border-white/5">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center font-bold text-black font-serif">
              Q
            </div>
            <span className="font-bold text-lg">Qur'on Focus</span>
          </div>
          <div className="flex items-center gap-2 bg-[#1a1a1a] px-3 py-1 rounded-full border border-white/10">
            <Trophy size={14} className="text-amber-400" />
            <span className="text-xs font-bold">{Math.floor(stats.totalMinutes / 60)}s {stats.totalMinutes % 60}m</span>
          </div>
        </header>

        {/* --- TABS --- */}

        {/* 1. FOCUS TAB */}
        {activeTab === 'focus' && (
          <div className="flex flex-col items-center justify-center flex-1 px-6 py-4 animate-in slide-in-from-right-4 duration-500">
            
            {/* Mode Switcher */}
            <div className="flex bg-[#1a1a1a] p-1 rounded-full mb-8 border border-white/10">
              <button 
                onClick={() => changeMode('focus')}
                className={`px-6 py-2 rounded-full text-sm font-medium transition-all ${timerMode === 'focus' ? 'bg-amber-500 text-black shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                Tilovat
              </button>
              <button 
                onClick={() => changeMode('break')}
                className={`px-6 py-2 rounded-full text-sm font-medium transition-all ${timerMode === 'break' ? 'bg-emerald-500 text-black shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                Dam olish
              </button>
            </div>

            {/* Smart Advice Chip */}
            <div className="mb-8 px-4 py-2 bg-blue-500/10 border border-blue-500/20 rounded-xl max-w-sm text-center">
              <p className="text-xs text-blue-200 flex items-center justify-center gap-2">
                <Brain size={12} />
                {timerActive ? "Chuqur diqqat rejimi aktiv" : MASLAHATLAR[Math.floor(Math.random() * MASLAHATLAR.length)]}
              </p>
            </div>

            {/* Timer Display */}
            <div className="relative mb-10 group">
              <div className={`absolute inset-0 rounded-full blur-[80px] opacity-20 transition-all duration-1000 ${timerActive ? 'bg-amber-500 scale-110' : 'bg-gray-600 scale-100'}`}></div>
              <div className="relative w-72 h-72 rounded-full border-8 border-[#1a1a1a] bg-[#09090b] flex flex-col items-center justify-center shadow-2xl z-10">
                 {/* Progress Ring simulation */}
                 <svg className="absolute inset-0 w-full h-full -rotate-90 pointer-events-none">
                   <circle cx="144" cy="144" r="130" fill="transparent" stroke="#1a1a1a" strokeWidth="4" />
                   <circle 
                      cx="144" cy="144" r="130" fill="transparent" 
                      stroke={timerMode === 'focus' ? '#f59e0b' : '#10b981'} strokeWidth="4" 
                      strokeDasharray={2 * Math.PI * 130}
                      strokeDashoffset={2 * Math.PI * 130 * (1 - timeLeft / (timerMode === 'focus' ? focusDuration * 60 : breakDuration * 60))}
                      strokeLinecap="round"
                      className="transition-all duration-1000"
                   />
                 </svg>
                 
                 <span className="text-7xl font-bold font-mono tracking-tighter tabular-nums text-white">
                   {formatTime(timeLeft)}
                 </span>
                 <span className="text-white/40 text-sm mt-2 uppercase tracking-widest font-medium">
                   {timerActive ? (timerMode === 'focus' ? 'O\'qimoqdasiz...' : 'Dam olmoqdasiz') : 'Tayyormisiz?'}
                 </span>
              </div>
            </div>

            {/* Controls */}
            <div className="flex items-center gap-6 mb-8">
              <button onClick={resetTimer} className="p-4 rounded-full bg-[#1a1a1a] text-gray-400 hover:text-white transition active:scale-95 border border-white/5">
                <RotateCcw size={24} />
              </button>
              
              {!timerActive && timerMode === 'focus' && timeLeft === focusDuration * 60 ? (
                 <button 
                  onClick={startFocusWithBreathing}
                  className="px-8 py-4 rounded-full bg-gradient-to-r from-amber-400 to-orange-500 text-black font-bold text-lg shadow-lg shadow-amber-500/20 active:scale-95 transition flex items-center gap-2"
                >
                  <Wind size={20} />
                  Nafas & Boshlash
                </button>
              ) : (
                <button 
                  onClick={toggleTimer}
                  className={`w-20 h-20 rounded-full flex items-center justify-center text-black text-2xl transition-all active:scale-90 shadow-2xl ${timerActive ? 'bg-[#1a1a1a] border border-amber-500 text-amber-500' : 'bg-amber-400 hover:bg-amber-300'}`}
                >
                  {timerActive ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="black" className="ml-1" />}
                </button>
              )}
            </div>

            {/* Timer Settings (Sliders) - Only visible when paused */}
            {!timerActive && (
              <div className="w-full max-w-xs bg-[#1a1a1a] p-4 rounded-2xl border border-white/5 animate-in fade-in">
                <div className="flex justify-between text-xs text-gray-400 mb-2">
                  <span>Focus: {focusDuration}m</span>
                  <span>Dam olish: {breakDuration}m</span>
                </div>
                <input 
                  type="range" min="5" max="60" step="5"
                  value={focusDuration} onChange={(e) => { setFocusDuration(Number(e.target.value)); setTimeLeft(Number(e.target.value) * 60); }}
                  className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-amber-500 mb-4"
                />
                <input 
                  type="range" min="1" max="15"
                  value={breakDuration} onChange={(e) => setBreakDuration(Number(e.target.value))}
                  className="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                />
              </div>
            )}
          </div>
        )}

        {/* 2. PLANNER TAB */}
        {activeTab === 'planner' && (
          <div className="px-6 py-6 space-y-6 animate-in slide-in-from-right-4 duration-500">
            <div className="bg-gradient-to-br from-[#1a1a1a] to-black border border-white/10 rounded-3xl p-6 relative overflow-hidden">
              <div className="absolute right-0 top-0 p-4 opacity-10"><BookOpen size={80} /></div>
              <h3 className="text-gray-400 text-xs font-medium uppercase mb-1">Bugungi Hikmat</h3>
              <p className="text-lg font-medium text-white italic leading-relaxed">"{randomQuote}"</p>
            </div>

            <div>
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold">Vazifalar</h3>
                <span className="text-xs text-gray-500">{tasks.filter(t => t.completed).length}/{tasks.length} bajarildi</span>
              </div>

              {/* Add Task Input */}
              <div className="flex gap-2 mb-4">
                <input 
                  type="text" 
                  value={newTaskTitle}
                  onChange={(e) => setNewTaskTitle(e.target.value)}
                  placeholder="Yangi sura yoki vazifa..."
                  className="flex-1 bg-[#1a1a1a] border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-amber-500 transition"
                  onKeyPress={(e) => e.key === 'Enter' && addTask()}
                />
                <button 
                  onClick={addTask}
                  className="p-3 bg-amber-500 text-black rounded-xl hover:bg-amber-400 transition"
                >
                  <Plus size={24} />
                </button>
              </div>

              <div className="space-y-3">
                {tasks.length === 0 ? (
                  <div className="text-center py-10 opacity-30">Vazifalar yo'q</div>
                ) : (
                  tasks.map(task => (
                    <div 
                      key={task.id}
                      onClick={() => toggleTask(task.id)}
                      className={`flex items-center gap-4 p-4 rounded-2xl border transition-all cursor-pointer ${task.completed ? 'bg-emerald-900/10 border-emerald-500/20 opacity-60' : 'bg-[#1a1a1a] border-white/5 hover:border-white/10'}`}
                    >
                      <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${task.completed ? 'bg-emerald-500 border-emerald-500' : 'border-gray-600'}`}>
                        {task.completed && <CheckCircle2 size={14} className="text-white" />}
                      </div>
                      <span className={`text-base ${task.completed ? 'line-through text-gray-500' : 'text-gray-200'}`}>{task.title}</span>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}

      </main>

      {/* --- BOTTOM NAVIGATION (Glassmorphism) --- */}
      <div className="fixed bottom-6 left-6 right-6 h-[72px] bg-black/80 backdrop-blur-2xl border border-white/10 rounded-[32px] flex items-center justify-around px-2 shadow-2xl z-50">
        <button 
          onClick={() => setActiveTab('planner')} 
          className={`p-3 rounded-full transition-all duration-300 flex flex-col items-center gap-1 ${activeTab === 'planner' ? 'text-amber-400' : 'text-gray-500 hover:text-white'}`}
        >
          <LayoutGrid size={24} className={activeTab === 'planner' ? 'fill-current' : ''} />
          <span className="text-[10px] font-medium">Reja</span>
        </button>

        <div className="relative -top-6">
          <button 
            onClick={() => setActiveTab('focus')}
            className={`w-16 h-16 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-all duration-300 border-4 border-[#09090b] ${activeTab === 'focus' ? 'bg-amber-400 text-black scale-110' : 'bg-[#1a1a1a] text-amber-500'}`}
          >
            <Clock size={28} className={activeTab === 'focus' ? 'fill-current animate-pulse' : ''} />
          </button>
        </div>

        <button 
          onClick={() => setActiveTab('stats')} 
          className={`p-3 rounded-full transition-all duration-300 flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'text-amber-400' : 'text-gray-500 hover:text-white'}`}
        >
          <BarChart2 size={24} className={activeTab === 'stats' ? 'fill-current' : ''} />
          <span className="text-[10px] font-medium">Hisob</span>
        </button>
      </div>

    </div>
  );
};

export default App;


