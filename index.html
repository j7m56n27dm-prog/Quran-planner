<!DOCTYPE html>
<html lang="uz" dir="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nur Parvozi">
    <meta name="theme-color" content="#0f1922">
    <title>Nur Parvozi - Qur'an Tadabbur & Hifz</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTnVyIFBhcnZvemkiLCJzaG9ydF9uYW1lIjoiTnVyIFBhcnZvemkiLCJkZXNjcmlwdGlvbiI6IlF1cuKAmWFuIHRhZGFiYnVyLCBoaWZ6IGFuZCBzcGlyaXR1YWwgZm9jdXMgUFdBIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE5MjIiLCJ0aGVtZV9jb2xvciI6IiNlZmQ5MzAiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWkhCaGNtNW5hVzVuYVd4bFkyOXRQMmNnY0hKdmVISmxkbTlsYVc1aGJtTmxQMmg0Ykd3dU5qQW5QMUJoZEdWUGNtVmZZMjl0Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlpIQmhjbTVuYVc1bmFXeGxZMjl0UDJjZ2NISnZlSEpsZG05bGFXNWhibU5sUDJoNGJHd3VNakF1TXpRbk8zQlFkR1ZUY21WZll5OW1JRjkzZW1obGJua2daMjkzWm1KbGMydHBibWN1TVM4MzBrMGciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" rel="manifest">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%230f1922' width='192' height='192'/%3E%3Ctext x='50%25' y='50%25' font-size='80' font-weight='bold' text-anchor='middle' dominant-baseline='central' fill='%23efd930'%3ENŸàÿ±%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Rakkas&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f1922 0%, #1a2535 100%);
            color: #e8f4f8;
        }

        :root {
            --primary: #efd930;
            --accent: #1abc9c;
            --dark-bg: #0f1922;
            --light-bg: #1a2535;
            --card-bg: rgba(26, 37, 53, 0.7);
            --border-glow: rgba(239, 217, 48, 0.3);
            --text-primary: #e8f4f8;
            --text-secondary: #a8c5d1;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        /* ===== MOOD THEMES ===== */
        [data-mood="anxious"] {
            --primary: #3498db;
            --accent: #1abc9c;
            --card-bg: rgba(52, 73, 94, 0.6);
        }

        [data-mood="repentant"] {
            --primary: #e74c3c;
            --accent: #c0392b;
            --card-bg: rgba(192, 57, 43, 0.5);
        }

        [data-mood="grateful"] {
            --primary: #2ecc71;
            --accent: #27ae60;
            --card-bg: rgba(39, 174, 96, 0.5);
        }

        [data-mood="focused"] {
            --primary: #f39c12;
            --accent: #d68910;
            --card-bg: rgba(243, 156, 18, 0.4);
        }

        [data-mood="peaceful"] {
            --primary: #9b59b6;
            --accent: #8e44ad;
            --card-bg: rgba(142, 68, 173, 0.5);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 217, 48, 0.3), inset 0 0 10px rgba(239, 217, 48, 0.1); }
            50% { box-shadow: 0 0 30px rgba(239, 217, 48, 0.6), inset 0 0 20px rgba(239, 217, 48, 0.2); }
        }

        @keyframes radianceExpand {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes slideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes floatUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(-20px); opacity: 0; }
        }

        @keyframes rotate3D {
            from { transform: rotateY(0deg) rotateX(0deg); }
            to { transform: rotateY(360deg) rotateX(10deg); }
        }

        @keyframes tawafRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes parallaxShift {
            0% { transform: translateZ(0px); }
            100% { transform: translateZ(50px); }
        }

        /* ===== CORE LAYOUT ===== */
        body {
            display: flex;
            flex-direction: column;
            perspective: 1000px;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            perspective: 1000px;
        }

        .screen {
            display: none;
            flex: 1;
            overflow-y: auto;
            animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 20px;
            perspective: 1000px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER/NAV ===== */
        header {
            background: linear-gradient(135deg, rgba(15, 25, 34, 0.95) 0%, rgba(26, 37, 53, 0.9) 100%);
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-glow);
            box-shadow: 0 10px 40px rgba(239, 217, 48, 0.1);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Rakkas', serif;
            text-shadow: 0 0 20px rgba(239, 217, 48, 0.5);
        }

        .header-icon {
            font-size: 24px;
            animation: rotate3D 8s linear infinite;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-nav {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-nav:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 20px var(--primary);
            transform: translateY(-2px);
        }

        .btn-nav.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 30px var(--primary);
        }

        /* ===== CARDS & ELEMENTS ===== */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: glowPulse 4s ease-in-out infinite;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(239, 217, 48, 0.2);
            border-color: var(--primary);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .card-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .badge {
            display: inline-block;
            background: var(--primary);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(239, 217, 48, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(239, 217, 48, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            margin: 5px;
        }

        /* ===== INPUT ===== */
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(239, 217, 48, 0.3);
            background: rgba(0, 0, 0, 0.5);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ===== PROGRESS & RINGS ===== */
        .progress-ring {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            position: relative;
            animation: tawafRing 20s linear infinite;
        }

        .progress-ring-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.35s ease;
            stroke: var(--primary);
            fill: none;
            stroke-width: 3;
            filter: drop-shadow(0 0 10px rgba(239, 217, 48, 0.5));
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .streak-counter {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ===== TIMER DISPLAY ===== */
        .timer-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(239, 217, 48, 0.5);
            margin: 30px 0;
            animation: breathe 3s ease-in-out infinite;
        }

        .breathing-indicator {
            width: 100px;
            height: 100px;
            background: var(--primary);
            border-radius: 50%;
            margin: 20px auto;
            opacity: 0.3;
            animation: breathe 6s ease-in-out infinite;
            box-shadow: 0 0 30px var(--primary);
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: slideIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--light-bg) 0%, rgba(15, 25, 34, 0.95) 100%);
            border: 2px solid var(--border-glow);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(239, 217, 48, 0.3);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close-btn:hover {
            transform: rotate(90deg);
        }

        /* ===== GRID ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .grid-item {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(239, 217, 48, 0.2);
            border-color: var(--primary);
        }

        .grid-item.selected {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        /* ===== RADIANCE BURST ===== */
        .radiance-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, var(--primary), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: radianceExpand 1.5s ease-out forwards;
        }

        /* ===== FLOATING ELEMENTS ===== */
        .floating-duaa {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            max-width: 250px;
            font-size: 12px;
            animation: floatUp 4s ease-in forwards;
            z-index: 500;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .header-title {
                font-size: 18px;
            }

            .timer-display {
                font-size: 36px;
            }

            .modal-content {
                max-width: 95%;
                padding: 20px;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(239, 217, 48, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* ===== RTL SUPPORT ===== */
        [dir="rtl"] .card-title,
        [dir="rtl"] .header-title {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .modal-header {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .nav-buttons {
            flex-direction: row-reverse;
        }

        /* ===== 3D EFFECTS ===== */
        .world-map-3d {
            width: 100%;
            height: 300px;
            background: radial-gradient(circle at 30% 30%, rgba(52, 152, 219, 0.2), transparent);
            border-radius: 16px;
            border: 2px solid var(--primary);
            margin: 20px 0;
            perspective: 1000px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 14px;
            text-align: center;
            padding: 20px;
            animation: parallaxShift 6s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(239, 217, 48, 0.1);
        }

        .location-pin {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            margin: 0 10px;
            animation: breathe 2s ease-in-out infinite;
        }
    </style>
</head>
<body data-mood="peaceful">
    <div class="container">
        <header>
            <div class="header-title">
                <span class="header-icon">üåü</span>
                <span id="headerTitle">Nur Parvozi</span>
            </div>
            <div class="nav-buttons">
                <button class="btn-nav active" data-screen="dashboard">üìä</button>
                <button class="btn-nav" data-screen="heartcheck">‚ù§Ô∏è</button>
                <button class="btn-nav" data-screen="session">üéØ</button>
                <button class="btn-nav" data-screen="hifz">üìñ</button>
                <button class="btn-nav" data-screen="settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- DASHBOARD SCREEN -->
        <div class="screen active" id="dashboard">
            <div class="card">
                <div class="card-title">üî• Bugungi Faoliyat</div>
                <div class="progress-ring">
                    <svg viewBox="0 0 100 100" style="width:100%; height:100%;">
                        <circle cx="50" cy="50" r="45" class="progress-ring-circle" id="progressCircle" stroke-dashoffset="0"></circle>
                    </svg>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <div class="card-content">
                    <div style="text-align:center; margin-bottom:10px;">
                        <span class="badge" id="streakBadge">üî• 0 kun</span>
                        <span class="badge" id="goalBadge">üéØ 0/3</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìÖ Bugungi Reja</div>
                <div class="card-content" id="dailyPlan">
                    <p>üïê 08:00 - Fajr Qur'an (5 min)</p>
                    <p>üïë 14:00 - Tadabbur (15 min)</p>
                    <p>üïí 20:00 - Hifz Review (10 min)</p>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üí° Bugungi Motivatsiya Ayati</div>
                <div class="card-content" id="motivationAyah" style="text-align:center; font-size:16px; line-height:1.8; color:var(--primary); font-weight:500;">
                    ŸÇÿßŸÑ ÿßŸÑŸÑŸá ÿ™ÿπÿßŸÑŸâ
                </div>
                <div style="text-align:center; margin-top:10px; color:var(--text-secondary);">
                    <span id="motivationTrans">Tafsir yoziladi...</span>
                </div>
            </div>

            <button class="btn" style="width:100%; margin-top:20px;" onclick="app.showScreen('heartcheck')">
                ‚ù§Ô∏è Heart Check Boshlash
            </button>
        </div>

        <!-- HEART CHECK SCREEN -->
        <div class="screen" id="heartcheck">
            <div class="card">
                <div class="card-title">‚ù§Ô∏è Xolatingni Tanlang</div>
                <div class="card-subtitle">Qalbingiz holati nima? Baraka ayatlari va duolar sizni kuzayotgan</div>
                <div class="grid">
                    <div class="grid-item" data-mood="anxious" onclick="app.setMood('anxious')">
                        üò∞ Tashvish
                    </div>
                    <div class="grid-item" data-mood="repentant" onclick="app.setMood('repentant')">
                        üôè Tavba
                    </div>
                    <div class="grid-item" data-mood="grateful" onclick="app.setMood('grateful')">
                        üôå Shukr
                    </div>
                    <div class="grid-item" data-mood="focused" onclick="app.setMood('focused')">
                        üéØ Murtakaz
                    </div>
                    <div class="grid-item" data-mood="peaceful" onclick="app.setMood('peaceful')">
                        üïäÔ∏è Tinch
                    </div>
                </div>
            </div>

            <div class="card" id="moodContent" style="display:none;">
                <div class="card-title" id="moodTitle">Tashvish Ayatlari</div>
                <div class="card-content" id="moodAyahs">
                    Ayatlar yoziladi...
                </div>
                <button class="btn" style="width:100%; margin-top:15px;" onclick="app.showScreen('session')">
                    Seans Boshlash ‚Üí
                </button>
            </div>

            <div class="card" id="tavbaChain">
                <div class="card-title">üîó 40 Kunlik Tavba Zanjiri</div>
                <div class="card-content">
                    <div style="text-align:center; font-size:32px; margin:15px 0;">
                        <span id="tavbaDays">0</span>/40
                    </div>
                    <div style="width:100%; background:rgba(0,0,0,0.3); height:10px; border-radius:5px; overflow:hidden;">
                        <div id="tavbaBar" style="width:0%; height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); transition:width 0.3s ease;"></div>
                    </div>
                    <p style="text-align:center; margin-top:10px; color:var(--text-secondary);">Ruhiy o'zgarishning sirri - konsistentlik</p>
                </div>
            </div>
        </div>

        <!-- SESSION SCREEN -->
        <div class="screen" id="session">
            <div class="card">
                <div class="card-title">üéØ Nur Parvozi Seansƒ±</div>
                <div class="card-subtitle">Ka'badan Jannaning bog'lariga uchaylik</div>
                
                <div style="text-align:center; margin:30px 0;">
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="breathing-indicator"></div>
                </div>

                <div class="world-map-3d" id="worldMap">
                    <span id="journeyText">üìç Toshkentdan Ka'baga uchaylik...</span>
                    <span class="location-pin"></span>
                </div>

                <div style="display:flex; gap:10px; margin:20px 0;">
                    <button class="btn" style="flex:1;" id="btnStartSession">‚ñ∂Ô∏è Boshlash</button>
                    <button class="btn btn-secondary" style="flex:1;" id="btnPauseSession">‚è∏ Pauza</button>
                    <button class="btn btn-secondary" style="flex:1;" id="btnStopSession">‚èπ Tugatish</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üéôÔ∏è Zikr & Nafas</div>
                <div style="text-align:center; margin:15px 0;">
                    <button class="btn btn-small" onclick="app.playZikr('subhanallah')">ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá</button>
                    <button class="btn btn-small" onclick="app.playZikr('alhamdulillah')">ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá</button>
                    <button class="btn btn-small" onclick="app.playZikr('allahuakbar')">ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±</button>
                </div>
                <div class="card-content" style="text-align:center; font-size:13px;">
                    ü´Å Nafas sinxronizatsiyasi: 4s ichga, 6s tashqariga
                </div>
            </div>

            <div class="card">
                <div class="card-title">üí¨ Dua & Fikr</div>
                <textarea id="reflectionText" placeholder="Qalbingiz nima suyaydi? Shukrlar, duolar yozing..."></textarea>
                <button class="btn" style="width:100%;" onclick="app.saveReflection()">üíæ Saqlash</button>
            </div>
        </div>

        <!-- HIFZ SCREEN -->
        <div class="screen" id="hifz">
            <div class="card">
                <div class="card-title">üìñ Adaptive Hifz Coach</div>
                <div class="card-subtitle">Ilmiy spacing repetition - Ebbinghaus egri chizig'i</div>
                
                <div class="grid">
                    <div class="grid-item">
                        <div style="font-size:24px;">üìö</div>
                        <div style="font-size:11px; margin-top:8px; font-weight:600;">Jami</div>
                        <div style="font-size:16px; color:var(--primary); font-weight:700;" id="totalHifz">0</div>
                    </div>
                    <div class="grid-item">
                        <div style="font-size:24px;">‚úÖ</div>
                        <div style="font-size:11px; margin-top:8px; font-weight:600;">Halol</div>
                        <div style="font-size:16px; color:var(--primary); font-weight:700;" id="correctHifz">0</div>
                    </div>
                    <div class="grid-item">
                        <div style="font-size:24px;">‚ö†Ô∏è</div>
                        <div style="font-size:11px; margin-top:8px; font-weight:600;">Xavotir</div>
                        <div style="font-size:16px; color:var(--warning); font-weight:700;" id="weakHifz">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üéì Bugungi Takrorlash</div>
                <div id="reviewList">
                    <p style="color:var(--text-secondary);">Ayatlar yuklanyotgan...</p>
                </div>
                <button class="btn" style="width:100%; margin-top:15px;" onclick="app.generateReview()">
                    üîÑ Yangi Review Boshlash
                </button>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div class="screen" id="settings">
            <div class="card">
                <div class="card-title">üåê Til</div>
                <select id="langSelect" onchange="app.setLanguage(this.value)">
                    <option value="uz">üá∫üáø Uzbek (O'zbekcha)</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
            </div>

            <div class="card">
                <div class="card-title">üé® Tema</div>
                <div class="grid">
                    <div class="grid-item" onclick="app.setTheme('anxious')" style="background:rgba(52, 73, 94, 0.6); border-color:#3498db;">üò∞</div>
                    <div class="grid-item" onclick="app.setTheme('repentant')" style="background:rgba(192, 57, 43, 0.5); border-color:#e74c3c;">üôè</div>
                    <div class="grid-item" onclick="app.setTheme('grateful')" style="background:rgba(39, 174, 96, 0.5); border-color:#2ecc71;">üôå</div>
                    <div class="grid-item" onclick="app.setTheme('focused')" style="background:rgba(243, 156, 18, 0.4); border-color:#f39c12;">üéØ</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üì± Distraction Shield</div>
                <div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
                    <input type="checkbox" id="distractionShield" checked style="width:20px; height:20px; cursor:pointer;">
                    <label for="distractionShield" style="flex:1; cursor:pointer;">30s o'zgartirish xavfsizligi</label>
                </div>
                <div class="card-content" style="font-size:12px; color:var(--text-secondary);">
                    ‚úì Tab o'zgarishi yoki distraktsiya niyati aniqlanadi. Duolar va zikr orqali qayta yo'naltirish.
                </div>
            </div>

            <div class="card">
                <div class="card-title">üîä Ovoz</div>
                <div style="margin:10px 0;">
                    <label style="display:block; margin:5px 0; font-size:12px;">
                        <input type="checkbox" id="ambientSound" checked> Ambient zikr ovozi
                    </label>
                    <label style="display:block; margin:5px 0; font-size:12px;">
                        <input type="checkbox" id="vibration" checked> Haptic feedback
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä Ma'lumotlar</div>
                <button class="btn" style="width:100%; margin:10px 0;" onclick="app.exportData()">üì• Export</button>
                <button class="btn btn-secondary" style="width:100%; margin:10px 0;" onclick="app.clearData()">üóëÔ∏è Tozalash</button>
            </div>

            <div class="card" style="text-align:center; background:rgba(239, 217, 48, 0.1); border-color:var(--primary);">
                <div style="font-size:12px; color:var(--text-secondary); margin:20px 0;">
                    Nur Parvozi v1.0<br>
                    üåü Made by Muhammad Daler<br>
                    Pure vanilla HTML5 ‚Ä¢ Zero Dependencies<br>
                    Qur'an & Ilm for 2025+
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Niyyah -->
    <div class="modal" id="niyyahModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ü§≤ Niyyah - Maqsadini Ayting</span>
                <button class="close-btn" onclick="document.getElementById('niyyahModal').classList.remove('active')">‚úï</button>
            </div>
            <div style="margin:20px 0;">
                <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">Ovozli yoki matn:</p>
                <textarea id="niyyahText" placeholder="Masalan: Allah uchun 5 sura hifz qilmoqchiman..." style="margin-bottom:10px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="flex:1;" onclick="app.recordNiyyah()">üé§ Ovozli</button>
                    <button class="btn" style="flex:1;" onclick="app.submitNiyyah()">‚úì Yuborish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Radiance Animation -->
    <div class="modal" id="radianceModal">
        <div class="modal-content" style="background:none; border:none; box-shadow:none; max-width:300px;">
            <div style="text-align:center;">
                <div style="font-size:64px; margin-bottom:20px; animation:rotate3D 3s linear infinite;">üåü</div>
                <div id="radianceText" style="font-size:18px; color:var(--primary); font-weight:700;">Nur yayilmoqda...</div>
            </div>
        </div>
    </div>

    <script>
        // ===== I18N STRINGS =====
        const i18n = {
            uz: {
                headerTitle: "Nur Parvozi",
                dailyActivity: "Bugungi Faoliyat",
                todayPlan: "Bugungi Reja",
                motivationAyah: "Bugungi Motivatsiya Ayati",
                startHeartCheck: "‚ù§Ô∏è Heart Check Boshlash",
                selectMood: "Xolatingni Tanlang",
                moodSubtitle: "Qalbingiz holati nima? Baraka ayatlari va duolar sizni kuzayotgan",
                tavbaChain: "üîó 40 Kunlik Tavba Zanjiri",
                sessionTitle: "üéØ Nur Parvozi Seansƒ±",
                sessionSubtitle: "Ka'badan Jannaning bog'lariga uchaylik",
                adaptiveHifz: "üìñ Adaptive Hifz Coach",
                todayReview: "üéì Bugungi Takrorlash",
                distraction: "üì± Distraction Shield",
                distractionDesc: "‚úì Tab o'zgarishi yoki distraktsiya niyati aniqlanadi. Duolar va zikr orqali qayta yo'naltirish.",
                language: "üåê Til",
                theme: "üé® Tema",
                sound: "üîä Ovoz",
                data: "üìä Ma'lumotlar",
                ambientSound: "Ambient zikr ovozi",
                vibration: "Haptic feedback",
                niyyah: "ü§≤ Niyyah - Maqsadini Ayting",
                niyyahDesc: "Ovozli yoki matn:",
                voiceRecord: "üé§ Ovozli",
                submit: "‚úì Yuborish",
            },
            ru: {
                headerTitle: "Nur –ü–∞—Ä–≤–æ–∑–∏",
                dailyActivity: "–î–Ω–µ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
                todayPlan: "–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è",
                motivationAyah: "–ê—è—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –¥–Ω—è",
                startHeartCheck: "‚ù§Ô∏è –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä–¥—Ü–∞",
                selectMood: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
                moodSubtitle: "–ö–∞–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞—à–µ–≥–æ —Å–µ—Ä–¥—Ü–∞? –ê–π–∞—Ç—ã –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏—è –∏ –¥—É–∞ –∂–¥—É—Ç –≤–∞—Å",
                tavbaChain: "üîó 40-–¥–Ω–µ–≤–Ω–∞—è —Ü–µ–ø—å —Ä–∞—Å–∫–∞—è–Ω–∏—è",
                sessionTitle: "üéØ –°–µ–∞–Ω—Å Nur Parvozi",
                sessionSubtitle: "–õ–µ—Ç–∏–º –æ—Ç –ö–∞–∞–±—ã –≤ —Å–∞–¥—ã –†–∞—è",
                adaptiveHifz: "üìñ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –•–∞—Ñ–∏–∑-—Ç—Ä–µ–Ω–µ—Ä",
                todayReview: "üéì –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è",
                distraction: "üì± –©–∏—Ç –æ—Ç –æ—Ç–≤–ª–µ—á–µ–Ω–∏–π",
                distractionDesc: "‚úì –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –æ—Ç–≤–ª–µ—á–µ–Ω–∏—è. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥—É–∞ –∏ –∑–∏–∫—Ä.",
                language: "üåê –Ø–∑—ã–∫",
                theme: "üé® –¢–µ–º–∞",
                sound: "üîä –ó–≤—É–∫",
                data: "üìä –î–∞–Ω–Ω—ã–µ",
                ambientSound: "–§–æ–Ω–æ–≤—ã–π –∑–≤—É–∫ –∑–∏–∫—Ä–∞",
                vibration: "–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å",
                niyyah: "ü§≤ –ù–∏—è - —Å–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é —Ü–µ–ª—å",
                niyyahDesc: "–ì–æ–ª–æ—Å–æ–º –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º:",
                voiceRecord: "üé§ –ì–æ–ª–æ—Å",
                submit: "‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å",
            },
            en: {
                headerTitle: "Nur Parvozi",
                dailyActivity: "Daily Activity",
                todayPlan: "Today's Plan",
                motivationAyah: "Today's Motivation Ayah",
                startHeartCheck: "‚ù§Ô∏è Start Heart Check",
                selectMood: "Select Your Mood",
                moodSubtitle: "What is your heart's state? Blessed ayahs and duas await you",
                tavbaChain: "üîó 40-Day Tawbah Chain",
                sessionTitle: "üéØ Nur Parvozi Session",
                sessionSubtitle: "Journey from Ka'ba to Paradise gardens",
                adaptiveHifz: "üìñ Adaptive Hifz Coach",
                todayReview: "üéì Today's Review",
                distraction: "üì± Distraction Shield",
                distractionDesc: "‚úì Detects tab switching or distraction intent. Redirect through duas and zikr.",
                language: "üåê Language",
                theme: "üé® Theme",
                sound: "üîä Sound",
                data: "üìä Data",
                ambientSound: "Ambient zikr sound",
                vibration: "Haptic feedback",
                niyyah: "ü§≤ Niyyah - State Your Goal",
                niyyahDesc: "Voice or text:",
                voiceRecord: "üé§ Voice",
                submit: "‚úì Submit",
            },
            ar: {
                headerTitle: "ŸÜŸàÿ± ÿßŸÑÿ∑Ÿäÿ±ÿßŸÜ",
                dailyActivity: "ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑŸäŸàŸÖŸä",
                todayPlan: "ÿÆÿ∑ÿ© ÿßŸÑŸäŸàŸÖ",
                motivationAyah: "ÿ¢Ÿäÿ© ÿßŸÑÿ™ÿ≠ŸÅŸäÿ≤",
                startHeartCheck: "‚ù§Ô∏è ÿßÿ®ÿØÿ£ ŸÅÿ≠ÿµ ÿßŸÑŸÇŸÑÿ®",
                selectMood: "ÿßÿÆÿ™ÿ± ŸÖÿ≤ÿßÿ¨ŸÉ",
                moodSubtitle: "ŸÖÿß ÿ≠ÿßŸÑÿ© ŸÇŸÑÿ®ŸÉÿü ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ±ŸÉÿ© ŸàÿßŸÑÿ£ÿØÿπŸäÿ© ÿ™ŸÜÿ™ÿ∏ÿ±ŸÉ",
                tavbaChain: "üîó ÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑÿ™Ÿàÿ®ÿ© ŸÑŸÖÿØÿ© 40 ŸäŸàŸÖÿßŸã",
                sessionTitle: "üéØ ÿ¨ŸÑÿ≥ÿ© ŸÜŸàÿ± ÿßŸÑÿ∑Ÿäÿ±ÿßŸÜ",
                sessionSubtitle: "ÿ±ÿ≠ŸÑÿ© ŸÖŸÜ ÿßŸÑŸÉÿπÿ®ÿ© ÿ•ŸÑŸâ ÿ¨ŸÜÿßŸÜ ÿßŸÑŸÅÿ±ÿØŸàÿ≥",
                adaptiveHifz: "üìñ ŸÖÿØÿ±ÿ® ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ™ŸÉŸäŸÅ",
                todayReview: "üéì ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸäŸàŸÖ",
                distraction: "üì± ÿØÿ±ÿπ ŸÖŸÜ ÿßŸÑÿ™ÿ¥ÿ™Ÿäÿ™",
                distractionDesc: "‚úì ŸäŸÉÿ™ÿ¥ŸÅ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿ£Ÿà ŸÜŸäÿ© ÿßŸÑÿ™ÿ¥ÿ™Ÿäÿ™. ÿ•ÿπÿßÿØÿ© ÿ™Ÿàÿ¨ŸäŸá ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿßŸÑÿ£ÿØÿπŸäÿ© ŸàÿßŸÑÿ∞ŸÉÿ±.",
                language: "üåê ÿßŸÑŸÑÿ∫ÿ©",
                theme: "üé® ÿßŸÑŸÖÿ∏Ÿáÿ±",
                sound: "üîä ÿßŸÑÿµŸàÿ™",
                data: "üìä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                ambientSound: "ÿµŸàÿ™ ÿßŸÑÿ∞ŸÉÿ± ÿßŸÑŸÖÿ≠Ÿäÿ∑",
                vibration: "ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÑŸÖÿ≥Ÿäÿ©",
                niyyah: "ü§≤ ÿßŸÑŸÜŸäÿ© - ÿßÿ∞ŸÉÿ± ŸÜŸäÿ™ŸÉ",
                niyyahDesc: "ÿµŸàÿ™ŸäÿßŸã ÿ£Ÿà ŸÜÿµŸäÿßŸã:",
                voiceRecord: "üé§ ÿµŸàÿ™",
                submit: "‚úì ÿ•ÿ±ÿ≥ÿßŸÑ",
            }
        };

        // ===== PREMIUM CONTENT DATABASE =====
        const contentDB = {
            ayahs: {
                uz: [
                    { text: "ÿ•ŸêŸÜŸéŸë ÿßŸÑŸÑŸéŸëŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸéŸëÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé", trans: "Albatta, Allah sabur bo'lganlarning bilan birga", surah: "Baqarah 2:153", mood: "anxious" },
                    { text: "ŸÅŸéÿ•ŸêŸÜŸéŸë ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß", trans: "Shubhasiz, qiyinchilikning bilan birga osonlik bor", surah: "Inshirah 94:5", mood: "anxious" },
                    { text: "ÿ±Ÿéÿ®ŸêŸë ÿßÿ∫ŸíŸÅŸêÿ±Ÿí ŸÑŸêŸä ŸàŸéÿßÿ±Ÿíÿ≠ŸéŸÖŸíŸÜŸêŸä", trans: "Ey Robbim, meni kechi va merhama qil", surah: "Tawbah 9:104", mood: "repentant" },
                    { text: "ÿ•ŸêŸÜŸéŸë ÿßŸÑŸÑŸéŸëŸáŸé ŸäŸèÿ≠Ÿêÿ®ŸèŸë ÿßŸÑÿ™ŸéŸëŸàŸéŸëÿßÿ®ŸêŸäŸÜŸé", trans: "Albatta, Allah tavba qiluvchilarga sevadi", surah: "Baqarah 2:222", mood: "repentant" },
                    { text: "ŸàŸéÿ•ŸêŸÜ ÿ™Ÿéÿ¥ŸíŸÉŸèÿ±ŸèŸàÿß ŸäŸéÿ±Ÿíÿ∂ŸéŸáŸè ŸÑŸéŸÉŸèŸÖŸí", trans: "Va agar shukr qilsangiz, u buni raza ko'radi", surah: "Zumar 39:7", mood: "grateful" },
                    { text: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé", trans: "Barcha hamdlar Allahga, alamlarning Robbiga", surah: "Fatiha 1:2", mood: "grateful" },
                    { text: "ŸàŸéŸÑŸêŸÑŸéŸëŸáŸê ÿßŸÑŸíÿ£Ÿéÿ≥ŸíŸÖŸéÿßÿ°Ÿè ÿßŸÑŸíÿ≠Ÿèÿ≥ŸíŸÜŸéŸâŸ∞", trans: "Allahga eng chiroyli nomlar tegishli", surah: "A'raf 7:180", mood: "peaceful" },
                    { text: "ÿ•ŸêŸÜŸéŸë ŸÜŸéŸÅŸíÿ≥Ÿé ÿßŸÑŸíŸÖŸèÿ§ŸíŸÖŸêŸÜŸê ÿ™Ÿéÿ∑ŸíŸÖŸéÿ¶ŸêŸÜŸèŸë ÿ®Ÿêÿ∞ŸêŸÉŸíÿ±Ÿê ÿßŸÑŸÑŸéŸëŸáŸê", trans: "Momin qalbi Allahni zikr bilan tinch topadi", surah: "Ra'd 13:28", mood: "peaceful" },
                ]
            },
            duas: {
                uz: [
                    "Allohumma inni as'aluka 'ilman naafi'an wa amalun salihan",
                    "Rabb-ana atina fi'd-dunya hasanatan wa fi'l-akhirate hasanatan wa qina 'adhaba'n-nar",
                    "Allohumma inni tawallaytu lla ilaha illa anta wa aslamt wajhi ilayk wa fawwadtu amri ilayk",
                    "Ya Muqallib al-qulub thabbit qalbi 'ala dinika",
                    "Allohumma ighfir li dhanbi kulla-hu, daqiqu-hu wa 'adhimu-hu",
                ]
            },
            locations: [
                { city: "Toshkent", distance: 0 },
                { city: "Samarqand", distance: 300 },
                { city: "Buxoro", distance: 600 },
                { city: "Baghdad", distance: 1500 },
                { city: "Dimashq", distance: 2000 },
                { city: "Quds", distance: 2500 },
                { city: "Makka", distance: 3500 },
                { city: "Jannaning Bog'lari", distance: 4000 },
            ]
        };

        // ===== MAIN APP CLASS =====
        class NurParvozi {
            constructor() {
                this.currentScreen = 'dashboard';
                this.currentLanguage = 'uz';
                this.currentMood = 'peaceful';
                this.sessionActive = false;
                this.sessionTime = 0;
                this.sessionDistance = 0;
                this.streak = 0;
                this.tavbaDays = 0;
                this.reflections = [];
                this.hifzData = [];
                
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                this.registerServiceWorker();
                this.generateDailyPlan();
                this.updateMoodContent();
                this.setRandomMotivationAyah();
                this.vibrate(50);
            }

            setupEventListeners() {
                // Nav buttons
                document.querySelectorAll('.btn-nav').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.showScreen(e.target.dataset.screen);
                    });
                });

                // Session buttons
                document.getElementById('btnStartSession').addEventListener('click', () => this.startSession());
                document.getElementById('btnPauseSession').addEventListener('click', () => this.pauseSession());
                document.getElementById('btnStopSession').addEventListener('click', () => this.stopSession());

                // Tab switch detection (Distraction Shield)
                document.addEventListener('visibilitychange', () => {
                    if (this.sessionActive && document.hidden && document.getElementById('distractionShield').checked) {
                        this.triggerDistractionShield();
                    }
                });
            }

            // ===== SCREEN NAVIGATION =====
            showScreen(screenName) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenName).classList.add('active');
                this.currentScreen = screenName;
            }

            // ===== MOOD SYSTEM =====
            setMood(mood) {
                this.currentMood = mood;
                document.body.dataset.mood = mood;
                document.querySelectorAll('.grid-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.dataset.mood === mood) item.classList.add('selected');
                });
                document.getElementById('moodContent').style.display = 'block';
                this.updateMoodContent();
                this.vibrate([50, 50, 100]);
            }

            updateMoodContent() {
                const moodTitles = {
                    anxious: "üò∞ Tashvish Ayatlari",
                    repentant: "üôè Tavba Duolari",
                    grateful: "üôå Shukr Ayatlari",
                    focused: "üéØ Murtakaz Ayatlari",
                    peaceful: "üïäÔ∏è Tinch Surah"
                };

                document.getElementById('moodTitle').textContent = moodTitles[this.currentMood];

                const ayahs = contentDB.ayahs.uz.filter(a => a.mood === this.currentMood);
                const ayahsHtml = ayahs.map(a => `
                    <div style="margin:15px 0; padding:15px; background:rgba(0,0,0,0.2); border-radius:8px; border-left:3px solid var(--primary);">
                        <div style="font-size:16px; line-height:1.8; color:var(--primary); font-weight:500; margin-bottom:8px;">${a.text}</div>
                        <div style="font-size:12px; color:var(--text-secondary);">${a.trans}</div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:8px;">üìç ${a.surah}</div>
                    </div>
                `).join('');
                document.getElementById('moodAyahs').innerHTML = ayahsHtml;
            }

            // ===== SESSION MANAGEMENT =====
            startSession() {
                this.sessionActive = true;
                this.sessionTime = 0;
                this.sessionDistance = 0;
                document.getElementById('btnStartSession').disabled = true;
                
                // Show Niyyah modal
                document.getElementById('niyyahModal').classList.add('active');
                this.vibrate([100, 50, 100]);

                this.sessionInterval = setInterval(() => {
                    this.sessionTime++;
                    this.updateSessionDisplay();
                }, 1000);
            }

            pauseSession() {
                clearInterval(this.sessionInterval);
                document.getElementById('btnStartSession').disabled = false;
                this.vibrate(50);
            }

            stopSession() {
                clearInterval(this.sessionInterval);
                this.sessionActive = false;
                this.saveReflection();
                document.getElementById('btnStartSession').disabled = false;
                this.incrementStreak();
                this.showRadianceAnimation("Baraka bersin! üåü");
            }

            updateSessionDisplay() {
                const mins = Math.floor(this.sessionTime / 60);
                const secs = this.sessionTime % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

                // Update journey
                this.sessionDistance = Math.floor((this.sessionTime / 60) * 50); // 50km per minute
                const location = contentDB.locations[Math.min(Math.floor(this.sessionDistance / 500), contentDB.locations.length - 1)];
                document.getElementById('journeyText').textContent = `üìç ${location.city} (${this.sessionDistance}km)`;

                // Update progress circle
                const progress = Math.min((this.sessionTime / 900) * 100, 100); // 15 min = 100%
                const circle = document.getElementById('progressCircle');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                circle.style.strokeDashoffset = circumference - (progress / 100) * circumference;
                document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            }

            // ===== NIYYAH VOICE RECORDING =====
            recordNiyyah() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("Ovoz tan olish bu brauzerda mavjud emas");
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'uz-UZ';
                recognition.start();
                document.getElementById('niyyahText').placeholder = "üéôÔ∏è Tinglanyotgan...";

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('niyyahText').value = transcript;
                };

                recognition.onerror = () => {
                    document.getElementById('niyyahText').placeholder = "‚ùå Xato. Qayta urinib ko'ring.";
                };
            }

            submitNiyyah() {
                const niyyah = document.getElementById('niyyahText').value;
                if (niyyah.trim()) {
                    document.getElementById('niyyahModal').classList.remove('active');
                    this.playZikrSound('subhanallah');
                    this.showRadianceAnimation("Niyyah qabul bo'ldi ü§≤");
                }
            }

            // ===== ZIKR & BREATHING =====
            playZikr(zikrType) {
                const zikrTexts = {
                    subhanallah: "ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá",
                    alhamdulillah: "ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá",
                    allahuakbar: "ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±"
                };

                this.speak(zikrTexts[zikrType]);
                this.vibrate([50, 30, 50, 30, 100]);
            }

            playZikrSound(type) {
                // Base64 encoded minimal audio sounds (silence + subtle tone)
                const sounds = {
                    subhanallah: new Audio('data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAAA='),
                };
                if (sounds[type]) sounds[type].play().catch(() => {});
            }

            speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.currentLanguage === 'ar' ? 'ar-SA' : this.currentLanguage === 'ru' ? 'ru-RU' : 'uz-UZ';
                    window.speechSynthesis.speak(utterance);
                }
            }

            // ===== REFLECTION CANVAS SHARE =====
            saveReflection() {
                const text = document.getElementById('reflectionText').value;
                if (text.trim()) {
                    const reflection = {
                        text,
                        date: new Date().toLocaleDateString(),
                        mood: this.currentMood,
                        time: this.sessionTime
                    };
                    this.reflections.push(reflection);
                    this.generateShareCard(reflection);
                    document.getElementById('reflectionText').value = '';
                    this.saveData();
                    this.vibrate([50, 50, 50]);
                }
            }

            generateShareCard(reflection) {
                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');

                // Background
                ctx.fillStyle = '#0f1922';
                ctx.fillRect(0, 0, 800, 400);

                // Gradient
                const gradient = ctx.createLinearGradient(0, 0, 800, 400);
                gradient.addColorStop(0, '#1a2535');
                gradient.addColorStop(1, '#0f1922');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 800, 400);

                // Title
                ctx.fillStyle = '#efd930';
                ctx.font = 'bold 36px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText('Nur Parvozi', 400, 60);

                // Reflection
                ctx.fillStyle = '#e8f4f8';
                ctx.font = '20px Poppins';
                ctx.textAlign = 'center';
                const words = reflection.text.split(' ');
                let line = '';
                let y = 150;
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > 700) {
                        ctx.fillText(line, 400, y);
                        line = words[i] + ' ';
                        y += 40;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, 400, y);

                // Footer
                ctx.fillStyle = '#a8c5d1';
                ctx.font = '14px Poppins';
                ctx.fillText(`üìÖ ${reflection.date} ‚Ä¢ üéØ ${Math.floor(reflection.time / 60)}min`, 400, 360);

                // Download
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `nur-parvozi-${Date.now()}.png`;
                link.click();
            }

            // ===== HIFZ SYSTEM =====
            generateReview() {
                const ayahs = contentDB.ayahs.uz;
                const review = ayahs.slice(0, 3).map((ayah, i) => `
                    <div style="margin:15px 0; padding:15px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:20px;">${ayah.text}</span>
                            <div style="flex:1;"></div>
                            <button class="btn btn-small" onclick="app.markHifzCorrect(${i})">‚úÖ</button>
                            <button class="btn btn-small" onclick="app.markHifzWeak(${i})">‚ö†Ô∏è</button>
                        </div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:8px;">${ayah.surah}</div>
                    </div>
                `).join('');
                document.getElementById('reviewList').innerHTML = review;
            }

            markHifzCorrect(index) {
                this.vibrate([100, 50, 100]);
                this.showRadianceAnimation("Eksellent! ‚≠ê");
            }

            markHifzWeak(index) {
                this.vibrate(50);
                alert("Bu ayet qayta takror qil");
            }

            // ===== DISTRACTION SHIELD =====
            triggerDistractionShield() {
                this.speak("Duoning waqti. Allohga yozing...");
                const dua = contentDB.duas.uz[Math.floor(Math.random() * contentDB.duas.uz.length)];
                const floating = document.createElement('div');
                floating.className = 'floating-duaa';
                floating.textContent = `ü§≤ ${dua}`;
                document.body.appendChild(floating);
                setTimeout(() => floating.remove(), 4000);
            }

            // ===== STREAK & TAVBAH =====
            incrementStreak() {
                this.streak++;
                this.tavbaDays = Math.min(this.tavbaDays + 1, 40);
                document.getElementById('streakBadge').textContent = `üî• ${this.streak} kun`;
                document.getElementById('tavbaDays').textContent = this.tavbaDays;
                document.getElementById('tavbaBar').style.width = `${(this.tavbaDays / 40) * 100}%`;
                this.saveData();
            }

            // ===== DAILY PLAN =====
            generateDailyPlan() {
                const plan = [
                    "üïê 08:00 - Fajr Qur'an (5 min)",
                    "üïë 14:00 - Tadabbur (15 min)",
                    "üïí 20:00 - Hifz Review (10 min)"
                ];
                document.getElementById('dailyPlan').innerHTML = plan.map(p => `<p>${p}</p>`).join('');
            }

            // ===== MOTIVATION AYAH =====
            setRandomMotivationAyah() {
                const ayahs = contentDB.ayahs.uz;
                const ayah = ayahs[Math.floor(Math.random() * ayahs.length)];
                document.getElementById('motivationAyah').textContent = ayah.text;
                document.getElementById('motivationTrans').textContent = `${ayah.trans} (${ayah.surah})`;
            }

            // ===== RADIANCE ANIMATION =====
            showRadianceAnimation(text) {
                const modal = document.getElementById('radianceModal');
                document.getElementById('radianceText').textContent = text;
                modal.classList.add('active');
                this.vibrate([100, 50, 100, 50, 150]);
                setTimeout(() => modal.classList.remove('active'), 2000);
            }

            // ===== LANGUAGE & THEME =====
            setLanguage(lang) {
                this.currentLanguage = lang;
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                this.saveData();
            }

            setTheme(theme) {
                this.setMood(theme);
            }

            // ===== DATA PERSISTENCE =====
            saveData() {
                const data = {
                    streak: this.streak,
                    tavbaDays: this.tavbaDays,
                    reflections: this.reflections,
                    language: this.currentLanguage,
                    mood: this.currentMood
                };
                localStorage.setItem('nurParvozi', JSON.stringify(data));
            }

            loadData() {
                const data = JSON.parse(localStorage.getItem('nurParvozi') || '{}');
                this.streak = data.streak || 0;
                this.tavbaDays = data.tavbaDays || 0;
                this.reflections = data.reflections || [];
                this.currentLanguage = data.language || 'uz';
                this.currentMood = data.mood || 'peaceful';
                
                document.body.dataset.mood = this.currentMood;
                document.getElementById('streakBadge').textContent = `üî• ${this.streak} kun`;
                document.getElementById('tavbaDays').textContent = this.tavbaDays;
                document.getElementById('tavbaBar').style.width = `${(this.tavbaDays / 40) * 100}%`;
            }

            exportData() {
                const data = JSON.parse(localStorage.getItem('nurParvozi') || '{}');
                const json = JSON.stringify(data, null, 2);
                const link = document.createElement('a');
                link.href = `data:application/json;base64,${btoa(json)}`;
                link.download = `nur-parvozi-backup-${Date.now()}.json`;
                link.click();
            }

            clearData() {
                if (confirm("Barcha ma'lumotlar o'chiriladi. Ishonchingiz komilmi?")) {
                    localStorage.removeItem('nurParvozi');
                    location.reload();
                }
            }

            // ===== VIBRATION FEEDBACK =====
            vibrate(pattern) {
                if (document.getElementById('vibration')?.checked && navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            }

            // ===== SERVICE WORKER =====
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdOdXJQYXJ2b3ppLXYxJzsgY29uc3QgVVJMX0NBQ0hFX0tFWSA9ICduLXAtdXJscyc7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCAoZXZlbnQpID0+IHsKICBlc2xpZi53YWl0VW50aWwoKCkgPT4gc2VsZi5jYWNoZXMub3BlbihDQUNIRV9OQU1FKS50aGVuKChjYWNoZSkgPT4gY2FjaGUuYWRkQWxsKFsKICAgICcvJywKICAgICcvaW5kZXguaHRtbCcsCiAgICAnL3N0eWxlLmNzcycsCiAgICAnL2pzL2FwcC5qcycsCiAgICAnL21hbmlmZXN0Lmpzb24nCiAgXSkpCn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsIChldmVudCkgPT4gewogIGV2ZW50LndhaXRVbnRpbChjYWNoZXMua2V5cyh0aGVuKChjYWNoZXMpID0+IHsKICAgIGNvbnN0IGNhY2hlS2V5cyA9IE9iamVjdC5rZXlzKGNhY2hlcykuZmlsdGVyKChraykgPT4gayAhPT0gQ0FDSEVfTkFNRSk7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoY2FjaGVLZXlzLm1hcCgoaykgPT4gY2FjaGVzLmRlbGV0ZShraykpKTsKICB9KSkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCAoZXZlbnQpID0+IHsKICBpZiAoZXZlbnQucmVxdWVzdC5tZXRob2QgIT09ICdHRVQnKSByZXR1cm47CiAgZXZlbnQucmVzcG9uZFdpdGgoY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICByZXR1cm4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCkudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgcmV0dXJuIGNhY2hlcyhDQUNIRV9OQU1FKS50aGVuKChjYWNoZSkgPT4gewogICAgICAgIGNhY2hlLnB1dChldmVudC5yZXF1ZXN0LCByZXNwb25zZS5jbG9uZSgpKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgIH0pOwogICAgfSkuY2F0Y2goKCkgPT4gY2FjaGVzLm1hdGNoKCdvZmZsaW5lJykpOwogIH0pKTsKfSk7CgovLyBCYWNrZ3JvdW5kIFN5bmM6IGHDoCBkZWdpsiEKc2VsZi5vbnN5bmMgPSAoZXZlbnQpID0+IHsKICBpZiAoZXZlbnQudGFnID09PSAnc3luYy10YXNrJykgewogICAgZXZlbnQud2FpdFVudGlsKHNlbGYucmVnaXN0cmF0aW9uLnN5bmMuc2V0VGFnKCduLXAtc3luYycpKTsKICB9Cn07') .catch(() => {});
                }
            }
        }

        // ===== INITIALIZE APP =====
        const app = new NurParvozi();

        // ===== INSTALL PWA PROMPT =====
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</head>
<body>
</body>
</html>